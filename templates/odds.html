<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="IL9Cast - Precinct-Level Monte Carlo Simulation Model for the IL-9 2026 Democratic Primary">
    <title>Model - IL9Cast</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing-style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WVTWQBBG8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WVTWQBBG8S');
    </script>
</head>
<script>
    (function() {
        var t = localStorage.getItem('il9-theme');
        if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    })();
</script>
<body>
    <div class="site-content">
        <header>
            <a href="/" class="logo">IL9<span>Cast</span></a>
            <nav class="desktop-nav">
                <a href="/markets">Markets</a>
                <a href="/odds" class="active">Model</a>
                <a href="/fundraising">Fundraising</a>
                <a href="/candidates">Candidates</a>
                <a href="/methodology">Methodology</a>
                <a href="/about">About</a>
            </nav>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
            <button class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav class="mobile-nav" id="mobileNav">
                <a href="/markets">Markets</a>
                <a href="/odds" class="active">Model</a>
                <a href="/fundraising">Fundraising</a>
                <a href="/candidates">Candidates</a>
                <a href="/methodology">Methodology</a>
                <a href="/about">About</a>
            </nav>
        </header>

        <section class="hero">
            <h1>Precinct Model</h1>
        </section>

        <div class="mobile-note">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            This interactive map is best viewed on a desktop or tablet.
        </div>

        <section class="model-page">

            <!-- Headline Win Probabilities -->
            <div class="model-headline">
                <div class="headline-meta">100,000 simulations &middot; 436 precincts &middot; Updated February 9, 2026</div>
                <div class="win-prob-cards">
                    <div class="win-prob-card">
                        <div class="prob-bar" style="background: #ef4444; width: 46.3%;"></div>
                        <div class="prob-info">
                            <span class="prob-name" style="color: #ef4444;">Biss</span>
                            <span class="prob-pct">~46%</span>
                        </div>
                    </div>
                    <div class="win-prob-card">
                        <div class="prob-bar" style="background: #3b82f6; width: 36.6%;"></div>
                        <div class="prob-info">
                            <span class="prob-name" style="color: #3b82f6;">Fine</span>
                            <span class="prob-pct">~37%</span>
                        </div>
                    </div>
                    <div class="win-prob-card">
                        <div class="prob-bar" style="background: #10b981; width: 17.1%;"></div>
                        <div class="prob-info">
                            <span class="prob-name" style="color: #10b981;">Abughazaleh</span>
                            <span class="prob-pct">~17%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Average Vote Shares -->
            <div class="model-section">
                <h2 class="model-section-heading">Average Vote Share</h2>
                <div class="vote-share-bars">
                    <div class="vs-row">
                        <span class="vs-name">Biss</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 58.0%; background: #ef4444;"></div></div>
                        <span class="vs-val">29.0%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Fine</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 51.0%; background: #3b82f6;"></div></div>
                        <span class="vs-val">25.5%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Abughazaleh</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 40.6%; background: #10b981;"></div></div>
                        <span class="vs-val">20.3%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Simmons</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 18.0%; background: #f59e0b;"></div></div>
                        <span class="vs-val">9.0%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Andrew</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 16.6%; background: #6366f1;"></div></div>
                        <span class="vs-val">8.3%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Amiwala</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 9.8%; background: #a855f7;"></div></div>
                        <span class="vs-val">4.9%</span>
                    </div>
                    <div class="vs-row">
                        <span class="vs-name">Huynh</span>
                        <div class="vs-track"><div class="vs-fill" style="width: 6.0%; background: #ec4899;"></div></div>
                        <span class="vs-val">3.0%</span>
                    </div>
                </div>
            </div>

            <!-- Interactive Map -->
            <div class="model-section model-map-section">
                <div class="map-header">
                    <div>
                        <h2 class="model-section-heading">Precinct Map</h2>
                        <p class="model-section-desc">Click a precinct to inspect detailed results. Switch layers to explore different views.</p>
                    </div>
                    <div class="layer-control" id="layerControl">
                        <div class="layer-control-label">Map Layer</div>
                        <label><input type="radio" name="layer" value="winner" checked> Winner</label>
                        <label><input type="radio" name="layer" value="margin"> Margin</label>
                        <label><input type="radio" name="layer" value="competitive"> Competitiveness</label>
                        <label><input type="radio" name="layer" value="biss"> Biss Heat</label>
                        <label><input type="radio" name="layer" value="fine"> Fine Heat</label>
                        <label><input type="radio" name="layer" value="abughazaleh"> Abughazaleh Heat</label>
                    </div>
                </div>
                <div class="map-container">
                    <div id="precinct-map"></div>
                    <div id="map-legend"></div>
                    <div id="info-panel">
                        <button id="close-info">&times;</button>
                        <h3 id="info-precinct"></h3>
                        <div class="winner-line" id="info-winner"></div>
                        <div id="info-bars"></div>
                        <div class="margin-line" id="info-margin"></div>
                        <div class="winrates" id="info-winrates"></div>
                    </div>
                    <div id="map-loading">Loading precinct data...</div>
                </div>
            </div>

            <!-- Detailed Data (for nerds) -->
            <div class="model-section nerd-section">
                <button class="nerd-toggle" id="nerdToggle" onclick="toggleNerdSection()">
                    <div>
                        <h2 class="model-section-heading" style="margin:0;">Detailed Precinct Data</h2>
                        <p class="model-section-desc" style="margin:0.25rem 0 0;">Sortable table of all 436 precincts with simulation results, margins, and 2024 presidential vote.</p>
                    </div>
                    <span class="nerd-arrow" id="nerdArrow">+</span>
                </button>
                <div class="nerd-body" id="nerdBody">

                    <!-- Competitiveness Breakdown -->
                    <div class="nerd-summary">
                        <h3>Competitiveness Breakdown</h3>
                        <div class="comp-grid" id="compGrid"></div>
                    </div>

                    <!-- Top Battlegrounds -->
                    <div class="nerd-summary">
                        <h3>Top 10 Battleground Precincts</h3>
                        <p class="nerd-sub">Tightest margins across the district.</p>
                        <div class="mini-table-wrap">
                            <table class="mini-table" id="battlegroundTable">
                                <thead>
                                    <tr>
                                        <th>Precinct</th>
                                        <th>Winner</th>
                                        <th>Runner-Up</th>
                                        <th>Margin</th>
                                        <th>Biss Win %</th>
                                        <th>Fine Win %</th>
                                        <th>Abu. Win %</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Full Precinct Table -->
                    <div class="nerd-summary">
                        <h3>All Precincts</h3>
                        <div class="table-controls">
                            <input type="text" id="precinctSearch" placeholder="Search precincts..." class="precinct-search">
                            <select id="winnerFilter" class="winner-filter">
                                <option value="">All Winners</option>
                                <option value="Biss">Biss</option>
                                <option value="Fine">Fine</option>
                                <option value="Abughazaleh">Abughazaleh</option>
                            </select>
                        </div>
                        <div class="full-table-wrap">
                            <table class="full-table" id="fullTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-col="JoinField">Precinct</th>
                                        <th class="sortable" data-col="winner">Winner</th>
                                        <th class="sortable sorted-desc" data-col="margin">Margin</th>
                                        <th class="sortable" data-col="runner_up">Runner-Up</th>
                                        <th class="sortable" data-col="avg_biss">Biss %</th>
                                        <th class="sortable" data-col="avg_fine">Fine %</th>
                                        <th class="sortable" data-col="avg_abughazaleh">Abu. %</th>
                                        <th class="sortable" data-col="avg_simmons">Sim. %</th>
                                        <th class="sortable" data-col="avg_andrew">And. %</th>
                                        <th class="sortable" data-col="avg_amiwala">Ami. %</th>
                                        <th class="sortable" data-col="avg_huynh">Huy. %</th>
                                        <th class="sortable" data-col="pct_biss_wins">Biss Win</th>
                                        <th class="sortable" data-col="pct_fine_wins">Fine Win</th>
                                        <th class="sortable" data-col="pct_abughazaleh_wins">Abu. Win</th>
                                        <th class="sortable" data-col="PresDem">'24 Dem</th>
                                        <th class="sortable" data-col="PresTot">'24 Total</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="table-footer" id="tableFooter">Showing 436 of 436 precincts</div>
                    </div>

                </div>
            </div>

            <!-- Model Graphs -->
            <div class="model-section">
                <h2 class="model-section-heading">Model Visualizations</h2>
                <p class="model-section-desc">Key outputs from the simulation. Click any chart to view full size.</p>
                <div class="graph-grid">
                    <a href="{{ url_for('static', filename='model/voteshare_density.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/voteshare_density.png') }}" alt="Vote Share Density" loading="lazy">
                        <div class="graph-caption">Vote Share Density</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/margin_histogram.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/margin_histogram.png') }}" alt="Margin Histogram" loading="lazy">
                        <div class="graph-caption">Win Margin Histogram</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/precinct_boxplot.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/precinct_boxplot.png') }}" alt="Precinct Vote Share Boxplot" loading="lazy">
                        <div class="graph-caption">Precinct Vote Share Boxplot</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/biss_vs_fine_scatter.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/biss_vs_fine_scatter.png') }}" alt="Biss vs Fine Scatter" loading="lazy">
                        <div class="graph-caption">Biss vs. Fine Scatter</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/kat_youth_scatter.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/kat_youth_scatter.png') }}" alt="Abughazaleh &amp; Youth Vote Scatter" loading="lazy">
                        <div class="graph-caption">Abughazaleh &amp; Youth Vote</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/fine_geography.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/fine_geography.png') }}" alt="Fine Geographic Strength" loading="lazy">
                        <div class="graph-caption">Fine Geographic Strength</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/turnout_vs_voteshare.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/turnout_vs_voteshare.png') }}" alt="Turnout vs Vote Share" loading="lazy">
                        <div class="graph-caption">Turnout vs. Vote Share</div>
                    </a>
                    <a href="{{ url_for('static', filename='model/county_winrates.png') }}" target="_blank" class="graph-card">
                        <img src="{{ url_for('static', filename='model/county_winrates.png') }}" alt="County Win Rates" loading="lazy">
                        <div class="graph-caption">County Win Rates</div>
                    </a>
                </div>
            </div>

        </section>

        <footer class="site-footer">
            <hr class="footer-rule">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Navigate</h4>
                    <ul>
                        <li><a href="/markets">Markets</a></li>
                        <li><a href="/candidates">Candidates</a></li>
                        <li><a href="/fundraising">Fundraising</a></li>
                        <li><a href="/methodology">Methodology</a></li>
                        <li><a href="/about">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="/api/download/snapshots">Download Data</a></li>
                        <li><a href="https://github.com/de-bayes/IL9" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                        <li><a href="https://buy.stripe.com/4gMdR98o72FP77e7jX1sQ00" target="_blank" rel="noopener noreferrer">Support This Project</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Disclaimer</h4>
                    <p>This model is for informational purposes only. Simulation results reflect probabilistic estimates based on available data and should not be interpreted as definitive predictions.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <span>&copy; 2026 IL9Cast. Built with open data.</span>
                <a href="https://buy.stripe.com/4gMdR98o72FP77e7jX1sQ00" target="_blank" rel="noopener noreferrer" class="footer-support-link">Support This Project</a>
            </div>
        </footer>
        <div class="flag-footer-image">
            <img src="{{ url_for('static', filename='flag-footer.png') }}" alt="Illinois Flag Footer">
        </div>
    </div>

    <style>
        /* ===== MODEL PAGE LAYOUT ===== */
        .model-page {
            max-width: 1100px;
            margin: 0 auto 4rem;
            padding: 0 2rem;
        }

        /* ===== HEADLINE WIN PROBABILITIES ===== */
        .model-headline {
            margin-bottom: 2rem;
        }
        .headline-meta {
            font-family: var(--sans);
            font-size: 0.9rem;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .win-prob-cards {
            display: flex;
            gap: 1rem;
        }
        .win-prob-card {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-left: 4px solid transparent;
            padding: 1.25rem 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .win-prob-card:nth-child(1) { border-left-color: #ef4444; }
        .win-prob-card:nth-child(2) { border-left-color: #3b82f6; }
        .win-prob-card:nth-child(3) { border-left-color: #10b981; }
        .prob-bar {
            position: absolute;
            top: 0; left: 0; height: 3px;
            border-radius: 0 2px 2px 0;
            opacity: 0.5;
        }
        .prob-info {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }
        .prob-name {
            font-family: var(--serif);
            font-size: 1.15rem;
            font-weight: 700;
        }
        .prob-pct {
            font-family: var(--sans);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        .prob-detail {
            font-family: var(--sans);
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        /* ===== VOTE SHARE BARS ===== */
        .model-section {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
        }
        .model-section-heading {
            font-family: var(--serif);
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.4rem;
        }
        .model-section-desc {
            font-family: var(--sans);
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0 0 1.25rem;
            line-height: 1.5;
        }
        .vote-share-bars {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }
        .vs-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .vs-name {
            font-family: var(--sans);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            width: 100px;
            text-align: right;
            flex-shrink: 0;
        }
        .vs-track {
            flex: 1;
            height: 20px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }
        .vs-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .vs-val {
            font-family: var(--sans);
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            width: 48px;
            text-align: right;
            flex-shrink: 0;
        }

        /* ===== MAP SECTION ===== */
        .model-map-section {
            padding: 2rem 2.5rem 2.5rem;
        }
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.5rem;
            margin-bottom: 1.25rem;
        }
        .layer-control {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem 1rem;
            align-items: center;
            flex-shrink: 0;
        }
        .layer-control-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            width: 100%;
            margin-bottom: 0.15rem;
        }
        .layer-control label {
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .layer-control input[type="radio"] {
            accent-color: var(--accent-blue);
            margin: 0;
        }
        .map-container {
            position: relative;
            z-index: 0;
            isolation: isolate;
        }
        #precinct-map {
            width: 100%;
            height: 600px;
            border-radius: 6px;
            background: #0f172a;
        }
        #map-loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--sans);
            font-size: 1rem;
            color: #94a3b8;
            z-index: 600;
        }

        /* ===== MAP LEGEND ===== */
        #map-legend {
            position: absolute;
            bottom: 12px; right: 12px;
            z-index: 800;
            background: rgba(15,23,42,0.93);
            backdrop-filter: blur(8px);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 10px 12px;
            min-width: 140px;
            color: #e2e8f0;
            font-family: var(--sans);
        }
        #map-legend h4 {
            font-size: 0.65rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 0 0 6px;
            font-weight: 600;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 1.5px 0;
        }
        .legend-swatch {
            width: 14px; height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-label {
            font-size: 0.7rem;
            color: #e2e8f0;
        }
        .legend-grad {
            width: 100%; height: 10px;
            border-radius: 3px;
            margin: 4px 0 2px;
        }
        .legend-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            color: #94a3b8;
        }

        /* ===== INFO PANEL ===== */
        #info-panel {
            position: absolute;
            bottom: 12px; left: 12px;
            z-index: 800;
            background: rgba(15,23,42,0.93);
            backdrop-filter: blur(8px);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 14px 16px;
            width: 300px;
            display: none;
            color: #e2e8f0;
            font-family: var(--sans);
        }
        #info-panel h3 {
            font-size: 0.8rem;
            color: #94a3b8;
            margin: 0 0 6px;
            font-weight: 500;
        }
        .winner-line {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        .bar-label {
            width: 80px;
            font-size: 0.7rem;
            color: #94a3b8;
            text-align: right;
            padding-right: 7px;
        }
        .bar-track {
            flex: 1;
            height: 13px;
            background: #1e293b;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 3px;
        }
        .bar-val {
            font-size: 0.6rem;
            color: #e2e8f0;
            position: absolute;
            right: 4px; top: 1px;
            font-weight: 600;
        }
        .margin-line {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 8px;
        }
        .winrates {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 4px;
        }
        #close-info {
            position: absolute;
            top: 6px; right: 8px;
            background: none; border: none;
            color: #64748b;
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }
        #close-info:hover { color: #e2e8f0; }

        /* ===== METHODOLOGY / META ===== */
        .model-meta-section {
            padding: 1.75rem 2.5rem;
        }
        .meta-row { }
        .method-link {
            color: var(--accent-blue);
            text-decoration: underline;
            font-weight: 600;
        }
        .meta-update-note {
            font-family: var(--sans);
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-default);
        }

        /* ===== MODEL GRAPHS ===== */
        .graph-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-width: 92%;
            margin: 0 auto;
        }
        .graph-card {
            display: block;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            overflow: hidden;
            text-decoration: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .graph-card:hover {
            border-color: var(--accent-blue);
            box-shadow: 0 2px 12px var(--shadow-soft);
        }
        .graph-card img {
            width: 100%;
            height: auto;
            display: block;
        }
        .graph-caption {
            font-family: var(--sans);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.6rem 0.75rem;
            border-top: 1px solid var(--border-default);
        }

        /* ===== NERD DATA SECTION ===== */
        .nerd-section { padding: 0; }
        .nerd-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 1.75rem 2.5rem;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            color: inherit;
        }
        .nerd-toggle:hover { background: var(--bg-surface-hover); }
        .nerd-arrow {
            font-family: var(--sans);
            font-size: 1.5rem;
            font-weight: 300;
            color: var(--text-tertiary);
            transition: transform 0.3s;
            flex-shrink: 0;
            margin-left: 1rem;
        }
        .nerd-arrow.open { transform: rotate(45deg); }
        .nerd-body {
            display: none;
            padding: 0 2.5rem 2rem;
        }
        .nerd-body.open { display: block; }
        .nerd-summary {
            margin-bottom: 2rem;
        }
        .nerd-summary h3 {
            font-family: var(--serif);
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem;
        }
        .nerd-sub {
            font-family: var(--sans);
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 0 0 0.75rem;
        }

        /* Competitiveness grid */
        .comp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        .comp-card {
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-default);
        }
        .comp-count {
            font-family: var(--sans);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }
        .comp-label {
            font-family: var(--sans);
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .comp-range {
            font-family: var(--sans);
            font-size: 0.65rem;
            color: var(--text-tertiary);
            margin-top: 0.15rem;
            opacity: 0.7;
        }

        /* Tables */
        .table-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .precinct-search {
            flex: 1;
            padding: 0.5rem 0.75rem;
            font-family: var(--sans);
            font-size: 0.85rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-primary);
            outline: none;
        }
        .precinct-search:focus { border-color: var(--accent-blue); }
        .precinct-search::placeholder { color: var(--text-tertiary); }
        .winner-filter {
            padding: 0.5rem 0.75rem;
            font-family: var(--sans);
            font-size: 0.85rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
        }
        .mini-table-wrap, .full-table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .mini-table, .full-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--sans);
            font-size: 0.8rem;
        }
        .mini-table th, .full-table th {
            text-align: left;
            padding: 0.5rem 0.6rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: var(--text-tertiary);
            border-bottom: 2px solid var(--border-default);
            white-space: nowrap;
            position: sticky;
            top: 0;
            background: var(--bg-surface);
            z-index: 1;
        }
        .full-table th.sortable { cursor: pointer; user-select: none; }
        .full-table th.sortable:hover { color: var(--text-primary); }
        .full-table th.sorted-asc::after { content: ' \u25B2'; font-size: 0.6rem; }
        .full-table th.sorted-desc::after { content: ' \u25BC'; font-size: 0.6rem; }
        .mini-table td, .full-table td {
            padding: 0.45rem 0.6rem;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-primary);
            white-space: nowrap;
        }
        .mini-table tr:hover td, .full-table tr:hover td {
            background: var(--bg-surface-hover);
        }
        .full-table-wrap {
            max-height: 500px;
            overflow-y: auto;
        }
        .winner-cell {
            font-weight: 600;
        }
        .table-footer {
            font-family: var(--sans);
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
            text-align: right;
        }

        /* ===== MOBILE NOTE ===== */
        .mobile-note {
            display: none;
            max-width: 1100px;
            margin: 0 auto 1rem;
            padding: 0.6rem 1.25rem;
            font-family: var(--sans);
            font-size: 0.8rem;
            color: var(--text-tertiary);
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            align-items: center;
            gap: 0.5rem;
        }
        .mobile-note svg { flex-shrink: 0; opacity: 0.6; }
        @media (max-width: 768px) {
            .mobile-note { display: flex; margin-left: 1rem; margin-right: 1rem; }
        }

        /* ===== LEAFLET OVERRIDES (dark map) ===== */
        .leaflet-container { background: #0f172a !important; }
        .leaflet-control-zoom { border: 1px solid #334155 !important; }
        .leaflet-control-zoom a {
            background: rgba(15,23,42,0.95) !important;
            color: #e2e8f0 !important;
            border-bottom-color: #334155 !important;
        }
        .leaflet-control-zoom a:hover { background: #1e293b !important; }
        .leaflet-tooltip {
            background: rgba(15,23,42,0.97) !important;
            color: #e2e8f0 !important;
            border: 1px solid #334155 !important;
            border-radius: 8px !important;
            font-size: 12px !important;
            padding: 10px 14px !important;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5) !important;
            font-family: var(--sans) !important;
            line-height: 1.5 !important;
            max-width: 280px !important;
            white-space: normal !important;
        }
        .leaflet-tooltip-top:before { border-top-color: rgba(15,23,42,0.97) !important; }
        .leaflet-tooltip-bottom:before { border-bottom-color: rgba(15,23,42,0.97) !important; }
        .tip-header { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
        .tip-winner { margin-bottom: 6px; }
        .tip-bars { margin-bottom: 4px; }
        .tip-bar-row { display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
        .tip-bar-name { width: 68px; font-size: 10px; color: #94a3b8; text-align: right; }
        .tip-bar-track { flex: 1; height: 8px; background: #1e293b; border-radius: 2px; overflow: hidden; }
        .tip-bar-fill { height: 100%; border-radius: 2px; }
        .tip-bar-val { font-size: 10px; width: 34px; text-align: right; font-weight: 600; }
        .tip-meta { font-size: 10px; color: #64748b; margin-top: 4px; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .model-page { padding: 0 1rem; }
            .win-prob-cards { flex-direction: column; }
            .prob-pct { font-size: 1.5rem; }
            .model-section { padding: 1.5rem 1.25rem; }
            .model-map-section { padding: 1.25rem 1rem 1.5rem; }
            .map-header { flex-direction: column; gap: 0.75rem; }
            .layer-control { gap: 0.15rem 0.75rem; }
            #precinct-map { height: 450px; }
            #info-panel { width: 260px; bottom: 8px; left: 8px; padding: 10px 12px; }
            #map-legend { bottom: 8px; right: 8px; }
            .vs-name { width: 80px; font-size: 0.8rem; }
            .graph-grid { max-width: 100%; }
            .nerd-toggle { padding: 1.25rem; }
            .nerd-body { padding: 0 1.25rem 1.5rem; }
            .comp-grid { grid-template-columns: repeat(3, 1fr); }
            .table-controls { flex-direction: column; }
        }
        @media (max-width: 480px) {
            #precinct-map { height: 380px; }
            .layer-control label { font-size: 0.72rem; }
            .comp-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>

    <script>
        function toggleTheme() {
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('il9-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('il9-theme', 'dark');
            }
        }

        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileNav = document.getElementById('mobileNav');
            hamburger.classList.toggle('active');
            mobileNav.classList.toggle('active');
        }

        document.querySelectorAll('#mobileNav a').forEach(function(link) {
            link.addEventListener('click', function() {
                document.getElementById('hamburger').classList.remove('active');
                document.getElementById('mobileNav').classList.remove('active');
            });
        });

        document.addEventListener('click', function(e) {
            var hamburger = document.getElementById('hamburger');
            var mobileNav = document.getElementById('mobileNav');
            if (!hamburger.contains(e.target) && !mobileNav.contains(e.target)) {
                hamburger.classList.remove('active');
                mobileNav.classList.remove('active');
            }
        });

        // ===== CANDIDATE COLORS =====
        var COLORS = {
            'Biss': '#ef4444',
            'Fine': '#3b82f6',
            'Abughazaleh': '#10b981',
            'Simmons': '#f59e0b',
            'Amiwala': '#a855f7',
            'Huynh': '#ec4899',
            'Andrew': '#6366f1'
        };
        var CAND_FIELDS = ['avg_biss','avg_abughazaleh','avg_fine','avg_simmons','avg_amiwala','avg_huynh','avg_andrew'];
        var CAND_NAMES = {
            'avg_biss': 'Biss',
            'avg_abughazaleh': 'Abughazaleh',
            'avg_fine': 'Fine',
            'avg_simmons': 'Simmons',
            'avg_amiwala': 'Amiwala',
            'avg_huynh': 'Huynh',
            'avg_andrew': 'Andrew'
        };

        // ===== MAP INIT =====
        var map = L.map('precinct-map', { zoomControl: true, attributionControl: false }).setView([42.00, -87.72], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, subdomains: 'abcd'
        }).addTo(map);

        var currentLayer = 'winner';
        var selectedFeature = null;
        var matchedLayer, unmatchedLayer;

        // ===== STYLE FUNCTIONS =====
        function winnerStyle(feature) {
            var p = feature.properties;
            return { fillColor: COLORS[p.winner] || '#475569', fillOpacity: 0.75, color: '#1e293b', weight: 0.8, opacity: 0.6 };
        }

        function marginStyle(feature) {
            var p = feature.properties;
            var m = p.margin || 0;
            var opacity = m >= 20 ? 1 : (m < 5 ? 0.35 : 0.35 + (m - 5) / 15 * 0.65);
            return { fillColor: COLORS[p.winner] || '#475569', fillOpacity: opacity, color: '#1e293b', weight: 0.8, opacity: 0.6 };
        }

        function heatStyle(field, hue) {
            return function(feature) {
                var val = feature.properties[field] || 0;
                var pct = Math.min(val / 45, 1);
                var lightness = 90 - pct * 60;
                var sat = 30 + pct * 70;
                return { fillColor: 'hsl(' + hue + ',' + sat + '%,' + lightness + '%)', fillOpacity: 0.8, color: '#1e293b', weight: 0.8, opacity: 0.6 };
            };
        }

        function competitiveStyle(feature) {
            var m = feature.properties.margin || 99;
            var c;
            if (m < 3) c = '#dc2626';
            else if (m < 5) c = '#f97316';
            else if (m < 8) c = '#eab308';
            else if (m < 12) c = '#84cc16';
            else c = '#22c55e';
            return { fillColor: c, fillOpacity: 0.75, color: '#1e293b', weight: 0.8, opacity: 0.6 };
        }

        function getStyle(feature) {
            switch (currentLayer) {
                case 'winner': return winnerStyle(feature);
                case 'margin': return marginStyle(feature);
                case 'biss': return heatStyle('avg_biss', 0)(feature);
                case 'fine': return heatStyle('avg_fine', 215)(feature);
                case 'abughazaleh': return heatStyle('avg_abughazaleh', 155)(feature);
                case 'competitive': return competitiveStyle(feature);
                default: return winnerStyle(feature);
            }
        }

        // ===== LEGEND =====
        function updateLegend() {
            var el = document.getElementById('map-legend');
            var html = '';
            switch (currentLayer) {
                case 'winner':
                    html = '<h4>Predicted Winner</h4>';
                    ['Biss','Fine','Abughazaleh','Simmons','Amiwala','Huynh','Andrew'].forEach(function(n) {
                        html += '<div class="legend-item"><div class="legend-swatch" style="background:' + COLORS[n] + '"></div><span class="legend-label">' + n + '</span></div>';
                    });
                    html += '<div class="legend-item"><div class="legend-swatch" style="background:#1e293b;opacity:0.5"></div><span class="legend-label">No Data</span></div>';
                    break;
                case 'margin':
                    html = '<h4>Win Margin</h4>';
                    html += '<div class="legend-item"><div class="legend-swatch" style="background:#94a3b8;opacity:1"></div><span class="legend-label">20+ pts</span></div>';
                    html += '<div class="legend-item"><div class="legend-swatch" style="background:#94a3b8;opacity:0.55"></div><span class="legend-label">~10 pts</span></div>';
                    html += '<div class="legend-item"><div class="legend-swatch" style="background:#94a3b8;opacity:0.35"></div><span class="legend-label">&lt;5 pts</span></div>';
                    html += '<div style="font-size:0.6rem;color:#64748b;margin-top:3px;">Color = winner</div>';
                    break;
                case 'biss':
                    html = '<h4>Biss Vote Share</h4>';
                    html += '<div class="legend-grad" style="background:linear-gradient(to right,hsl(0,30%,90%),hsl(0,100%,30%))"></div>';
                    html += '<div class="legend-range"><span>0%</span><span>45%</span></div>';
                    break;
                case 'fine':
                    html = '<h4>Fine Vote Share</h4>';
                    html += '<div class="legend-grad" style="background:linear-gradient(to right,hsl(215,30%,90%),hsl(215,100%,30%))"></div>';
                    html += '<div class="legend-range"><span>0%</span><span>45%</span></div>';
                    break;
                case 'abughazaleh':
                    html = '<h4>Abughazaleh Vote Share</h4>';
                    html += '<div class="legend-grad" style="background:linear-gradient(to right,hsl(155,30%,90%),hsl(155,100%,30%))"></div>';
                    html += '<div class="legend-range"><span>0%</span><span>45%</span></div>';
                    break;
                case 'competitive':
                    html = '<h4>Competitiveness</h4>';
                    [['#dc2626','&lt;3 pts (Toss-up)'],['#f97316','3\u20135 pts'],['#eab308','5\u20138 pts'],['#84cc16','8\u201312 pts'],['#22c55e','12+ pts (Safe)']].forEach(function(x) {
                        html += '<div class="legend-item"><div class="legend-swatch" style="background:' + x[0] + '"></div><span class="legend-label">' + x[1] + '</span></div>';
                    });
                    break;
            }
            el.innerHTML = html;
        }

        // ===== INFO PANEL =====
        function showInfo(p) {
            document.getElementById('info-panel').style.display = 'block';
            document.getElementById('info-precinct').textContent = p.JoinField;
            document.getElementById('info-winner').innerHTML =
                '<span style="color:' + COLORS[p.winner] + '">' + p.winner + '</span> \u2014 ' + p.winner_pct + '%';

            var cands = CAND_FIELDS.map(function(f) { return { name: CAND_NAMES[f], val: p[f] || 0, color: COLORS[CAND_NAMES[f]] }; });
            cands.sort(function(a, b) { return b.val - a.val; });
            var maxVal = Math.max.apply(null, cands.map(function(c) { return c.val; }));
            var barsHtml = '';
            cands.forEach(function(c) {
                var w = (c.val / (maxVal * 1.1)) * 100;
                barsHtml += '<div class="bar-row"><div class="bar-label">' + c.name + '</div>' +
                    '<div class="bar-track"><div class="bar-fill" style="width:' + w + '%;background:' + c.color + '"></div>' +
                    '<div class="bar-val">' + c.val.toFixed(1) + '%</div></div></div>';
            });
            document.getElementById('info-bars').innerHTML = barsHtml;
            document.getElementById('info-margin').innerHTML =
                'Margin over ' + p.runner_up + ': <strong>+' + p.margin + ' pts</strong>';

            var wr = '';
            if (p.pct_biss_wins != null) wr += '<span style="color:#ef4444">Biss ' + p.pct_biss_wins.toFixed(1) + '%</span>';
            if (p.pct_fine_wins != null) wr += ' &middot; <span style="color:#3b82f6">Fine ' + p.pct_fine_wins.toFixed(1) + '%</span>';
            if (p.pct_abughazaleh_wins != null) wr += ' &middot; <span style="color:#10b981">Abu. ' + p.pct_abughazaleh_wins.toFixed(1) + '%</span>';
            document.getElementById('info-winrates').innerHTML = wr;
        }

        document.getElementById('close-info').onclick = function() {
            document.getElementById('info-panel').style.display = 'none';
            if (selectedFeature) {
                selectedFeature.setStyle({ color: getStyle(selectedFeature.feature).color, weight: getStyle(selectedFeature.feature).weight });
                selectedFeature = null;
            }
        };

        // ===== LAYER SWITCHING =====
        document.querySelectorAll('input[name=layer]').forEach(function(radio) {
            radio.addEventListener('change', function() {
                currentLayer = this.value;
                if (matchedLayer) {
                    matchedLayer.eachLayer(function(layer) {
                        layer.setStyle(getStyle(layer.feature));
                    });
                }
                if (selectedFeature) {
                    selectedFeature.setStyle({ color: '#ffffff', weight: 3 });
                    selectedFeature.bringToFront();
                }
                updateLegend();
            });
        });

        // Click map to deselect
        map.on('click', function() {
            if (selectedFeature) {
                selectedFeature.setStyle({ color: getStyle(selectedFeature.feature).color, weight: getStyle(selectedFeature.feature).weight });
                selectedFeature = null;
            }
            document.getElementById('info-panel').style.display = 'none';
        });

        // ===== NERD SECTION TOGGLE =====
        function toggleNerdSection() {
            var body = document.getElementById('nerdBody');
            var arrow = document.getElementById('nerdArrow');
            body.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        // ===== NERD DATA (populated after GeoJSON loads) =====
        var allPrecinctData = [];
        var currentSort = { col: 'margin', asc: true }; // tightest first

        function buildCompGrid(data) {
            var buckets = [
                { label: 'Toss-up', range: '<3 pts', color: '#dc2626', count: 0 },
                { label: 'Lean', range: '3-5 pts', color: '#f97316', count: 0 },
                { label: 'Likely', range: '5-8 pts', color: '#eab308', count: 0 },
                { label: 'Favored', range: '8-12 pts', color: '#84cc16', count: 0 },
                { label: 'Safe', range: '12+ pts', color: '#22c55e', count: 0 }
            ];
            data.forEach(function(p) {
                var m = p.margin || 99;
                if (m < 3) buckets[0].count++;
                else if (m < 5) buckets[1].count++;
                else if (m < 8) buckets[2].count++;
                else if (m < 12) buckets[3].count++;
                else buckets[4].count++;
            });
            var html = '';
            buckets.forEach(function(b) {
                html += '<div class="comp-card" style="background:' + b.color + '15;">' +
                    '<div class="comp-count">' + b.count + '</div>' +
                    '<div class="comp-label" style="color:' + b.color + '">' + b.label + '</div>' +
                    '<div class="comp-range">' + b.range + '</div></div>';
            });
            document.getElementById('compGrid').innerHTML = html;
        }

        function buildBattlegroundTable(data) {
            var sorted = data.slice().sort(function(a, b) { return (a.margin || 99) - (b.margin || 99); });
            var top10 = sorted.slice(0, 10);
            var tbody = document.querySelector('#battlegroundTable tbody');
            var html = '';
            top10.forEach(function(p) {
                html += '<tr>' +
                    '<td>' + p.JoinField + '</td>' +
                    '<td class="winner-cell" style="color:' + COLORS[p.winner] + '">' + p.winner + '</td>' +
                    '<td>' + p.runner_up + '</td>' +
                    '<td><strong>' + (p.margin != null ? p.margin.toFixed(1) : '-') + '</strong></td>' +
                    '<td>' + (p.pct_biss_wins != null ? p.pct_biss_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '<td>' + (p.pct_fine_wins != null ? p.pct_fine_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '<td>' + (p.pct_abughazaleh_wins != null ? p.pct_abughazaleh_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = html;
        }

        function renderFullTable() {
            var search = document.getElementById('precinctSearch').value.toLowerCase();
            var winnerFilter = document.getElementById('winnerFilter').value;

            var filtered = allPrecinctData.filter(function(p) {
                if (search && p.JoinField.toLowerCase().indexOf(search) === -1) return false;
                if (winnerFilter && p.winner !== winnerFilter) return false;
                return true;
            });

            // Sort
            filtered.sort(function(a, b) {
                var va = a[currentSort.col];
                var vb = b[currentSort.col];
                if (va == null) va = currentSort.asc ? Infinity : -Infinity;
                if (vb == null) vb = currentSort.asc ? Infinity : -Infinity;
                if (typeof va === 'string') {
                    return currentSort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                }
                return currentSort.asc ? va - vb : vb - va;
            });

            var tbody = document.querySelector('#fullTable tbody');
            var html = '';
            filtered.forEach(function(p) {
                var demPct = p.PresTot > 0 ? ((p.PresDem / p.PresTot) * 100).toFixed(0) + '%' : '-';
                html += '<tr>' +
                    '<td>' + p.JoinField + '</td>' +
                    '<td class="winner-cell" style="color:' + COLORS[p.winner] + '">' + p.winner + '</td>' +
                    '<td><strong>' + (p.margin != null ? p.margin.toFixed(1) : '-') + '</strong></td>' +
                    '<td>' + (p.runner_up || '-') + '</td>' +
                    '<td>' + (p.avg_biss != null ? p.avg_biss.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_fine != null ? p.avg_fine.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_abughazaleh != null ? p.avg_abughazaleh.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_simmons != null ? p.avg_simmons.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_andrew != null ? p.avg_andrew.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_amiwala != null ? p.avg_amiwala.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.avg_huynh != null ? p.avg_huynh.toFixed(1) : '-') + '</td>' +
                    '<td>' + (p.pct_biss_wins != null ? p.pct_biss_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '<td>' + (p.pct_fine_wins != null ? p.pct_fine_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '<td>' + (p.pct_abughazaleh_wins != null ? p.pct_abughazaleh_wins.toFixed(1) + '%' : '-') + '</td>' +
                    '<td>' + demPct + '</td>' +
                    '<td>' + (p.PresTot || '-') + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = html;
            document.getElementById('tableFooter').textContent = 'Showing ' + filtered.length + ' of ' + allPrecinctData.length + ' precincts';
        }

        // Sort click handler
        document.querySelectorAll('#fullTable th.sortable').forEach(function(th) {
            th.addEventListener('click', function() {
                var col = this.dataset.col;
                if (currentSort.col === col) {
                    currentSort.asc = !currentSort.asc;
                } else {
                    currentSort.col = col;
                    currentSort.asc = col === 'JoinField' || col === 'winner' || col === 'runner_up';
                }
                // Update header classes
                document.querySelectorAll('#fullTable th.sortable').forEach(function(h) {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });
                this.classList.add(currentSort.asc ? 'sorted-asc' : 'sorted-desc');
                renderFullTable();
            });
        });

        // Search & filter handlers
        document.getElementById('precinctSearch').addEventListener('input', renderFullTable);
        document.getElementById('winnerFilter').addEventListener('change', renderFullTable);

        // ===== LOAD GEOJSON =====
        fetch('{{ url_for("static", filename="model/il9_precinct_model.geojson") }}')
            .then(function(r) { return r.json(); })
            .then(function(geojson) {
                document.getElementById('map-loading').style.display = 'none';

                var matchedFeatures = [];
                var unmatchedFeatures = [];
                geojson.features.forEach(function(f) {
                    if (f.properties.winner === 'No Data') {
                        unmatchedFeatures.push(f);
                    } else {
                        matchedFeatures.push(f);
                    }
                });

                // Unmatched (context boundaries)
                unmatchedLayer = L.geoJSON({ type: 'FeatureCollection', features: unmatchedFeatures }, {
                    style: { fillColor: '#1e293b', fillOpacity: 0.3, color: '#1e293b', weight: 0.5, opacity: 0.4 },
                    interactive: false
                }).addTo(map);

                // Matched precincts
                matchedLayer = L.geoJSON({ type: 'FeatureCollection', features: matchedFeatures }, {
                    style: getStyle,
                    onEachFeature: function(feature, layer) {
                        var p = feature.properties;

                        // Build rich tooltip with mini bar chart
                        var cands = CAND_FIELDS.map(function(f) {
                            return { name: CAND_NAMES[f], val: p[f] || 0, color: COLORS[CAND_NAMES[f]] };
                        }).sort(function(a, b) { return b.val - a.val; });
                        var topMax = cands[0].val;

                        var barsHtml = '';
                        cands.forEach(function(c) {
                            var w = topMax > 0 ? (c.val / topMax) * 100 : 0;
                            barsHtml += '<div class="tip-bar-row">' +
                                '<span class="tip-bar-name">' + c.name + '</span>' +
                                '<div class="tip-bar-track"><div class="tip-bar-fill" style="width:' + w + '%;background:' + c.color + '"></div></div>' +
                                '<span class="tip-bar-val">' + c.val.toFixed(1) + '%</span></div>';
                        });

                        var winRates = '';
                        if (p.pct_biss_wins != null) winRates += '<span style="color:#ef4444">Biss ' + p.pct_biss_wins.toFixed(0) + '%</span>';
                        if (p.pct_fine_wins != null) winRates += ' &middot; <span style="color:#3b82f6">Fine ' + p.pct_fine_wins.toFixed(0) + '%</span>';
                        if (p.pct_abughazaleh_wins != null) winRates += ' &middot; <span style="color:#10b981">Abu. ' + p.pct_abughazaleh_wins.toFixed(0) + '%</span>';

                        var tip = '<div class="tip-header">' + p.JoinField + '</div>' +
                            '<div class="tip-winner"><span style="color:' + COLORS[p.winner] + ';font-weight:700;">' + p.winner + '</span> wins &middot; +' + p.margin + ' pts over ' + p.runner_up + '</div>' +
                            '<div style="font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;">Avg. Vote Share</div>' +
                            '<div class="tip-bars">' + barsHtml + '</div>' +
                            '<div style="font-size:9px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-top:6px;margin-bottom:2px;">Sim. Win Rate</div>' +
                            '<div class="tip-meta" style="color:#e2e8f0;">' + winRates + '</div>';

                        layer.bindTooltip(tip, { sticky: true, direction: 'top', offset: [0, -12] });

                        layer.on('mouseover', function() {
                            if (selectedFeature !== layer) {
                                layer.setStyle({ color: '#94a3b8', weight: 2 });
                            }
                            layer.bringToFront();
                        });
                        layer.on('mouseout', function() {
                            if (selectedFeature !== layer) {
                                layer.setStyle({ color: getStyle(feature).color, weight: getStyle(feature).weight });
                            }
                        });
                        layer.on('click', function(e) {
                            L.DomEvent.stopPropagation(e);
                            if (selectedFeature) {
                                selectedFeature.setStyle({ color: getStyle(selectedFeature.feature).color, weight: getStyle(selectedFeature.feature).weight });
                            }
                            selectedFeature = layer;
                            layer.setStyle({ color: '#ffffff', weight: 3 });
                            layer.bringToFront();
                            showInfo(p);
                        });
                    }
                }).addTo(map);

                map.fitBounds(matchedLayer.getBounds(), { padding: [20, 20] });
                updateLegend();

                // Populate nerd section
                allPrecinctData = matchedFeatures.map(function(f) { return f.properties; });
                buildCompGrid(allPrecinctData);
                buildBattlegroundTable(allPrecinctData);
                renderFullTable();
            });
    </script>
</body>
</html>
