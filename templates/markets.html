<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Primary Meta Tags -->
    <title>Live Prediction Markets - IL9Cast | Illinois 9th District Primary 2026</title>
    <meta name="title" content="Live Prediction Markets - IL9Cast | Illinois 9th District Primary 2026">
    <meta name="description" content="Real-time prediction market odds for Illinois 9th District Democratic Primary 2026. Aggregated data from Manifold Markets and Kalshi, updated every 3 minutes. See live market trends and historical charts.">
    <meta name="keywords" content="prediction markets, IL9 primary odds, Manifold Markets IL9, Kalshi IL9, Illinois 9th District forecast, live election odds, market trends">
    <link rel="canonical" href="https://il9.org/markets">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://il9.org/markets">
    <meta property="og:title" content="Live Prediction Markets - IL9Cast | Illinois 9th District Primary 2026">
    <meta property="og:description" content="Real-time prediction market odds for Illinois 9th District Democratic Primary 2026. Updated every 3 minutes from Manifold Markets and Kalshi.">
    <meta property="og:site_name" content="IL9Cast">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://il9.org/markets">
    <meta property="twitter:title" content="Live Prediction Markets - IL9Cast">
    <meta property="twitter:description" content="Real-time prediction market odds for Illinois 9th District Democratic Primary 2026.">

    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing-style.css') }}">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WVTWQBBG8S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-WVTWQBBG8S');
    </script>
</head>
<script>
    (function() {
        var t = localStorage.getItem('il9-theme');
        if (t === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
    })();
</script>
<body>


    <div class="site-content">
        <header>
            <a href="/" class="logo">IL9<span>Cast</span></a>
            <nav class="desktop-nav">
                <a href="/markets" class="active">Markets</a>
                <a href="/candidates">Candidates</a>
                <a href="/fundraising">Fundraising</a>
                <a href="/odds">Model</a>
                <a href="/updates">Updates</a>
                <a href="/methodology">Methodology</a>
                <a href="/about">About</a>
            </nav>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
                <svg class="icon-moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg class="icon-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
            <button class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <nav class="mobile-nav" id="mobileNav">
                <a href="/markets" class="active">Markets</a>
                <a href="/candidates">Candidates</a>
                <a href="/fundraising">Fundraising</a>
                <a href="/odds">Model</a>
                <a href="/updates">Updates</a>
                <a href="/methodology">Methodology</a>
                <a href="/about">About</a>
            </nav>
        </header>

        <section class="hero">
            <h1>Prediction Markets</h1>
            <p class="subtitle">Aggregated odds from multiple prediction markets</p>
        </section>

        <section class="markets-content-page">
            <section class="leader-featured" id="leaderFeatured">
                <div class="leader-card">
                    <img src="" alt="" class="leader-photo" id="leaderPhoto">
                    <div class="leader-info">
                        <span class="leader-label">LEADING CANDIDATE</span>
                        <span class="leader-name" id="leaderName">Loading...</span>
                        <div class="leader-main-stat">
                            <span class="leader-main-label">Aggregate Probability</span>
                            <span class="leader-main-value" id="leaderAggregate">--%</span>
                        </div>
                        <div class="leader-divider"></div>
                        <div class="leader-sub-stats">
                            <div class="leader-sub-stat">
                                <span class="leader-sub-label">Manifold</span>
                                <span class="leader-sub-value" id="leaderManifold">--%</span>
                            </div>
                            <div class="leader-sub-stat">
                                <span class="leader-sub-label">Kalshi Last</span>
                                <span class="leader-sub-value" id="leaderKalshiLast">--%</span>
                            </div>
                            <div class="leader-sub-stat">
                                <span class="leader-sub-label">Kalshi Mid</span>
                                <span class="leader-sub-value" id="leaderKalshiMid">--%</span>
                            </div>
                            <div class="leader-sub-stat">
                                <span class="leader-sub-label">Kalshi Liq</span>
                                <span class="leader-sub-value" id="leaderKalshiLiq">--%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="big-odds-display" id="bigOddsDisplay">
                <div class="big-odds-candidate">
                    <span class="big-percent">--</span>
                    <span class="big-name">Loading...</span>
                </div>
            </section>

            <section class="market-chart-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">Market Trends</h2>
                    <div class="chart-toggle" id="chartToggle">
                        <button class="toggle-btn" data-period="1d">1 Day</button>
                        <button class="toggle-btn active" data-period="7d">7 Days</button>
                        <button class="toggle-btn" data-period="all">All Time</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="marketTrendChart"></canvas>
                </div>
                <p class="chart-subtitle">
                    We have JSONL data upon request from Jan 15 to 30, but some AWS volume issues
                    prevented us from displaying it. The graph has data from Jan 30 and on.
                    All times displayed in Central Time (CT).
                </p>
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button id="shareButton" class="share-button">
                        <span class="share-icon">ðŸ“¤</span>
                        <span class="share-text">Share Current Standings</span>
                    </button>
                </div>
                <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-default); font-size: 0.8rem; color: var(--text-tertiary); text-align: center;">
                    For detailed aggregation methodology, see the <a href="/methodology#foldout-pm" style="color: var(--accent-blue); text-decoration: underline;">Prediction Markets Aggregation section</a> on the Methodology page.
                </p>
            </section>

            <section class="heatmap-callout" id="heatmapSection">
                <div class="heatmap-callout-header">
                    <h2>Results Heatmap</h2>
                    <p class="heatmap-callout-desc">Derived probabilities for every 1st &amp; 2nd place finish combination</p>
                </div>
                <div class="heatmap-callout-body">
                    <div id="heatmapContent">
                        <p style="color: var(--text-secondary);">Loading market data...</p>
                    </div>
                    <p style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-default); font-size: 0.9rem; color: var(--text-secondary);">
                        For the full methodology details, see the <a href="/methodology#heatmap-methodology" style="color: var(--accent-blue); text-decoration: underline;">Results Heatmap section</a> on the Methodology page.
                    </p>
                </div>
            </section>

            <section class="donation-section">
                <p class="donation-text">
                    Make a donation to line my pockets. No, to pay for server costs.
                    <a href="https://buy.stripe.com/4gMdR98o72FP77e7jX1sQ00" target="_blank" rel="noopener noreferrer" class="donation-link">Support IL9Cast</a>
                </p>
            </section>

            <section class="calculation-breakdown method-foldout" id="calculationBreakdown">
                <button class="foldout-trigger" onclick="toggleCalcFoldout()">
                    <div class="foldout-trigger-left">
                        <div>
                            <h2>Calculation Breakdown</h2>
                            <p class="foldout-desc">Live formula application for each candidate</p>
                        </div>
                    </div>
                    <span class="foldout-arrow" id="calc-foldout-arrow">+</span>
                </button>
                <div class="foldout-body" id="calc-foldout-body">
                    <div class="foldout-inner">
                        <div id="breakdownContent"></div>
                        <p class="breakdown-desc" style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-default);">
                            <strong>*</strong> = No Kalshi market available. Uses 100% of Manifold probability. Probabilities are lightly normalized (30% strength) to prevent excessive drift while preserving raw market values for top candidates.
                        </p>
                    </div>
                </div>
            </section>

            <section class="additional-markets">
                <h2>Market Sources</h2>

                <div class="expandable-market" id="manifoldMarket">
                    <button class="expand-toggle" onclick="toggleMarket('manifoldMarket')">
                        <span class="market-name">
                            Manifold Markets
                            <span class="live-badge" id="manifoldBadge">
                                <span class="live-dot"></span>
                                LIVE
                            </span>
                        </span>
                        <span class="market-preview" id="manifoldPreview">Loading...</span>
                        <span class="expand-icon">+</span>
                    </button>
                    <div class="expand-content">
                        <div class="market-candidates" id="manifoldCandidates">
                            <div class="market-candidate">
                                <span class="candidate-name">Loading...</span>
                                <span class="candidate-odds">--</span>
                            </div>
                        </div>
                        <div class="market-footer">
                            <span class="last-updated" id="manifoldUpdated">Fetching data...</span>
                            <a href="https://manifold.markets/JeromeHPowell/who-will-win-the-democratic-primary-RZdcps6dL9" target="_blank" class="market-link">View on Manifold â†’</a>
                        </div>
                    </div>
                </div>

                <div class="expandable-market" id="kalshiMarket">
                    <button class="expand-toggle" onclick="toggleMarket('kalshiMarket')">
                        <span class="market-name">
                            Kalshi
                            <span class="live-badge" id="kalshiBadge">
                                <span class="live-dot"></span>
                                LIVE
                            </span>
                        </span>
                        <span class="market-preview" id="kalshiPreview">Loading...</span>
                        <span class="expand-icon">+</span>
                    </button>
                    <div class="expand-content">
                        <div class="market-candidates" id="kalshiCandidates">
                            <div class="market-candidate">
                                <span class="candidate-name">Loading...</span>
                                <span class="candidate-odds">--</span>
                            </div>
                        </div>
                        <div class="market-footer">
                            <span class="last-updated" id="kalshiUpdated">Fetching data...</span>
                            <a href="https://kalshi.com/markets/kxil9d/il-9-democratic-primary/kxil9d-26" target="_blank" class="market-link">View on Kalshi â†’</a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Email Alerts Section -->
            <section class="email-alerts-section">
                <h2>Get Email Alerts</h2>
                <p class="alerts-description">Receive big swing alerts and a daily summary at 8 AM CT</p>
                <form class="subscribe-form" id="subscribeForm" onsubmit="return handleSubscribe(event)">
                    <input type="email" id="subscribeEmail" placeholder="your@email.com" required class="subscribe-input" />
                    <select id="subscribeThreshold" class="subscribe-threshold">
                        <option value="2">Alert at 2%+ moves</option>
                        <option value="3">Alert at 3%+ moves</option>
                        <option value="5" selected>Alert at 5%+ moves</option>
                        <option value="7">Alert at 7%+ moves</option>
                        <option value="10">Alert at 10%+ moves</option>
                    </select>
                    <button type="submit" class="subscribe-button">Subscribe</button>
                </form>
                <div id="subscribeMessage" class="subscribe-message"></div>
            </section>

            <!-- Download Data Section -->
            <section class="download-data-section">
                <h2>Download Historical Data</h2>
                <p class="download-description">Download the complete historical snapshot data in your preferred format</p>
                <div class="download-buttons">
                    <a href="/api/download/snapshots/csv" class="download-button" download>
                        <span class="download-icon">â¬‡</span>
                        Download CSV
                    </a>
                    <a href="/api/download/snapshots" class="download-button download-button-secondary" download>
                        <span class="download-icon">â¬‡</span>
                        Download JSONL
                    </a>
                </div>
            </section>
        </section>

        <!-- Email Subscribe Popup Modal -->
        <div id="emailModal" class="email-modal">
            <div class="email-modal-overlay" onclick="closeEmailModal()"></div>
            <div class="email-modal-content">
                <button class="email-modal-close" onclick="closeEmailModal()">&times;</button>
                <h2>Get Email Alerts</h2>
                <p class="email-modal-description">Receive big swing alerts and a daily summary at 8 AM CT</p>
                <form class="subscribe-form" id="subscribeFormModal" onsubmit="return handleSubscribeModal(event)">
                    <input type="email" id="subscribeEmailModal" placeholder="your@email.com" required class="subscribe-input" />
                    <select id="subscribeThresholdModal" class="subscribe-threshold">
                        <option value="2">Alert at 2%+ moves</option>
                        <option value="3">Alert at 3%+ moves</option>
                        <option value="5" selected>Alert at 5%+ moves</option>
                        <option value="7">Alert at 7%+ moves</option>
                        <option value="10">Alert at 10%+ moves</option>
                    </select>
                    <button type="submit" class="subscribe-button">Subscribe</button>
                </form>
                <div id="subscribeMessageModal" class="subscribe-message"></div>
            </div>
        </div>

        <footer class="site-footer">
            <hr class="footer-rule">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Navigate</h4>
                    <ul>
                        <li><a href="/markets">Markets</a></li>
                        <li><a href="/candidates">Candidates</a></li>
                        <li><a href="/fundraising">Fundraising</a></li>
                        <li><a href="/methodology">Methodology</a></li>
                        <li><a href="/about">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="/api/download/snapshots">Download Data</a></li>
                        <li><a href="https://github.com/de-bayes/IL9" target="_blank" rel="noopener noreferrer">GitHub</a></li>
                        <li><a href="https://buy.stripe.com/4gMdR98o72FP77e7jX1sQ00" target="_blank" rel="noopener noreferrer">Support This Project</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Disclaimer</h4>
                    <p>Prediction markets involve risk. Past performance does not guarantee future results. This platform aggregates public market data for informational purposes only.</p>
                </div>
            </div>
            <div class="footer-bottom">
                <span>&copy; 2026 IL9Cast. Built with open data.</span>
                <a href="https://buy.stripe.com/4gMdR98o72FP77e7jX1sQ00" target="_blank" rel="noopener noreferrer" class="footer-support-link">Support This Project</a>
            </div>
        </footer>
        <div class="flag-footer-image">
            <img src="{{ url_for('static', filename='flag-footer.png') }}" alt="Illinois Flag Footer">
        </div>
    </div>

    <style>

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .leader-featured,
        .big-odds-display,
        .market-chart-section,
        .additional-markets {
            animation: fadeInUp 0.7s ease-out;
        }

        .markets-content-page {
            max-width: 900px;
            margin: 0 auto 4rem;
            padding: 0 2rem;
            position: relative;
        }


        /* Share Button */
        .share-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s ease;
            font-family: var(--sans);
        }

        .share-button:hover {
            opacity: 0.8;
        }

        .share-button:active {
            transform: translateY(0);
        }

        .share-icon {
            font-size: 1.1rem;
        }

        @media (max-width: 480px) {
            .share-button {
                font-size: 0.85rem;
                padding: 0.65rem 1.2rem;
            }
        }

        /* Leader Featured Card */
        .leader-featured {
            margin: 0 0 2rem 0;
        }

        .leader-card {
            display: flex;
            gap: 2rem;
            padding: 2.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
        }

        .leader-photo {
            width: 140px;
            height: 140px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            opacity: 0.95;
        }

        .leader-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
        }

        .leader-label {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .leader-name {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--serif);
            margin-bottom: 1rem;
        }

        .leader-main-stat {
            margin-top: 0.5rem;
        }

        .leader-main-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .leader-main-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            font-family: var(--sans);
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .leader-divider {
            width: 100%;
            height: 1px;
            background: var(--border-subtle);
            margin: 1rem 0;
        }

        .leader-sub-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem 2rem;
        }

        .leader-sub-stat {
            display: flex;
            flex-direction: column;
        }

        .leader-sub-label {
            font-size: 0.6rem;
            font-weight: 600;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.2rem;
            opacity: 0.7;
        }

        .leader-sub-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-blue);
            font-family: var(--sans);
            line-height: 1;
        }

        /* Tablet and large phone landscape */
        @media (max-width: 768px) {
            .markets-content-page {
                padding: 0 1.5rem;
            }

            .leader-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 2rem;
            }

            .leader-photo {
                width: 120px;
                height: 120px;
            }

            .leader-name {
                font-size: 2rem;
            }

            .leader-main-value {
                font-size: 3rem;
            }

            .leader-sub-stats {
                justify-content: center;
                gap: 1.25rem 1.75rem;
            }

            .big-odds-display {
                grid-template-columns: repeat(3, 1fr);
            }

            .market-chart-section h2 {
                font-size: 1.5rem;
            }

            .market-chart-section .chart-wrapper {
                height: 280px;
            }
        }

        /* Large phones */
        @media (max-width: 600px) {
            .leader-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 1.5rem;
            }
            .leader-photo {
                width: 100px;
                height: 100px;
            }
            .leader-name {
                font-size: 1.6rem;
            }
            .leader-main-value {
                font-size: 2.5rem;
            }
            .leader-sub-stats {
                justify-content: center;
                gap: 1rem 1.5rem;
            }
            .leader-sub-value {
                font-size: 1.1rem;
            }
            .market-chart-section {
                padding: 1.5rem;
            }
            .market-chart-section h2 {
                font-size: 1.4rem;
                margin-bottom: 1rem;
            }
            .market-chart-section .chart-wrapper {
                height: 240px;
            }
            .chart-toggle {
                gap: 0.2rem;
            }
            .toggle-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .chart-subtitle {
                font-size: 0.75rem;
                margin-top: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .hero h1 {
                font-size: 1.8rem;
            }

            .hero .subtitle {
                font-size: 0.9rem;
            }

            .markets-content-page {
                padding: 1rem;
            }

            .leader-card {
                padding: 1rem;
                gap: 1rem;
            }

            .leader-photo {
                width: 80px;
                height: 80px;
            }

            .leader-label {
                font-size: 0.65rem;
                letter-spacing: 0.06em;
            }

            .leader-name {
                font-size: 1.35rem;
            }

            .leader-main-label {
                font-size: 0.6rem;
            }

            .leader-main-value {
                font-size: 2rem;
            }

            .leader-sub-stats {
                gap: 0.8rem 1rem;
            }

            .leader-sub-label {
                font-size: 0.55rem;
            }

            .leader-sub-value {
                font-size: 0.95rem;
            }

            .big-odds-display {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-bottom: 1.5rem;
            }

            .big-odds-candidate {
                padding: 1rem 0.4rem;
            }

            .big-percent {
                font-size: 2rem;
                margin-bottom: 0.4rem;
            }

            .big-name {
                font-size: 0.8rem;
            }

            .market-chart-section {
                padding: 1.25rem;
                margin-bottom: 1.5rem;
            }

            .market-chart-section h2 {
                font-size: 1.2rem;
                margin-bottom: 0.75rem;
            }

            .market-chart-section .chart-wrapper {
                height: 200px;
            }

            .chart-toggle {
                gap: 0.15rem;
            }

            .toggle-btn {
                padding: 0.35rem 0.65rem;
                font-size: 0.75rem;
            }

            .chart-subtitle {
                font-size: 0.7rem;
                margin-top: 0.6rem;
            }

            .market-chart-section > div {
                flex-direction: column;
                gap: 0.75rem;
            }
        }

        @media (max-width: 375px) {
            .hero h1 {
                font-size: 1.5rem;
            }

            .hero .subtitle {
                font-size: 0.8rem;
            }

            .markets-content-page {
                padding: 0.75rem;
            }

            .leader-featured {
                margin-bottom: 1rem;
            }

            .leader-card {
                padding: 0.75rem;
            }

            .leader-photo {
                width: 70px;
                height: 70px;
            }

            .leader-name {
                font-size: 1.2rem;
            }

            .leader-main-value {
                font-size: 1.75rem;
            }

            .leader-sub-value {
                font-size: 0.85rem;
            }

            .big-odds-display {
                gap: 0.6rem;
                margin-bottom: 1.25rem;
            }

            .big-odds-candidate {
                padding: 0.75rem 0.35rem;
            }

            .big-percent {
                font-size: 1.75rem;
                margin-bottom: 0.3rem;
            }

            .big-name {
                font-size: 0.75rem;
            }

            .market-chart-section {
                padding: 1rem;
                margin-bottom: 1.25rem;
            }

            .market-chart-section h2 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
            }

            .market-chart-section .chart-wrapper {
                height: 180px;
            }

            .toggle-btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
        }

        /* Odds Grid */
        .big-odds-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 140px), 1fr));
            gap: 1rem;
            margin: 0 0 2rem 0;
            text-align: center;
        }

        .big-odds-candidate {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 0.5rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
        }

        .big-percent {
            font-size: 3.5rem;
            font-weight: 700;
            font-family: var(--sans);
            color: var(--accent-blue);
            line-height: 1;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .big-name {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @media (max-width: 900px) {
            .big-odds-display {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 500px) {
            .big-odds-display {
                grid-template-columns: repeat(2, 1fr);
            }
            .big-percent {
                font-size: 2.5rem;
            }
        }

        /* Chart Section */
        .market-chart-section {
            padding: 2rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            margin-bottom: 2rem;
        }

        .chart-subtitle {
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            font-style: italic;
            text-align: center;
        }

        .market-chart-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.6rem;
            color: var(--accent-blue);
            font-family: var(--serif);
            font-weight: 700;
        }

        .market-chart-section .chart-wrapper {
            height: 320px;
            position: relative;
            padding: 0.5rem 0;
            width: 100%;
        }

        .chart-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-elevated);
            padding: 4px;
            border: 1px solid var(--border-default);
            flex-wrap: wrap;
            justify-content: center;
            width: auto;
        }

        .toggle-btn {
            padding: 0.5rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            border-radius: 6px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            font-family: var(--sans);
            transition: all 0.25s ease;
        }

        .toggle-btn:hover {
            color: var(--text-secondary);
            background: var(--bg-surface-hover);
        }

        .toggle-btn.active {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }

        /* Methodology Foldout */
        /* Calculation Breakdown */
        .donation-section {
            text-align: center;
            padding: 1.5rem 2rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-left: 3px solid var(--accent-gold);
            margin-bottom: 2rem;
        }

        .donation-text {
            margin: 0;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .donation-link {
            display: inline-block;
            margin-left: 0.75rem;
            padding: 0.5rem 1.25rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            text-decoration: none;
            font-weight: 600;
            transition: opacity 0.15s ease;
        }

        .donation-link:hover {
            opacity: 0.8;
            color: var(--bg-primary);
        }

        /* ===== CALCULATION BREAKDOWN FOLDOUT ===== */
        .calculation-breakdown.method-foldout {
            background: var(--bg-surface);
            border: 2px solid var(--border-default);
            margin-bottom: 2rem;
            overflow: hidden;
            padding: 0;
        }

        .calculation-breakdown.method-foldout.active {
            border-color: var(--border-hover);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .calculation-breakdown .foldout-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.8rem 2.2rem;
            background: none;
            border: none;
            cursor: pointer;
            text-align: left;
            color: inherit;
            transition: background 0.3s ease;
        }

        .calculation-breakdown .foldout-trigger:hover {
            background: var(--bg-surface-hover);
        }

        .calculation-breakdown .foldout-trigger-left {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .calculation-breakdown .foldout-trigger h2 {
            margin-bottom: 0;
            font-size: 1.6rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
            line-height: 1.3;
        }

        .calculation-breakdown .foldout-desc {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 0.2rem 0 0 0;
            line-height: 1.4;
        }

        .calculation-breakdown .foldout-arrow {
            font-family: var(--sans);
            font-size: 1.6rem;
            font-weight: 300;
            color: var(--accent-gold);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            flex-shrink: 0;
            width: 30px;
            text-align: center;
            line-height: 1;
        }

        .calculation-breakdown .foldout-arrow.open {
            transform: rotate(45deg);
        }

        .calculation-breakdown .foldout-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s cubic-bezier(0.34, 1.12, 0.64, 1),
                        opacity 0.4s ease;
            opacity: 0;
        }

        .calculation-breakdown .foldout-body.open {
            grid-template-rows: 1fr;
            opacity: 1;
        }

        .calculation-breakdown .foldout-inner {
            overflow: hidden;
            padding: 0 2.2rem;
        }

        .calculation-breakdown .foldout-body.open .foldout-inner {
            padding-bottom: 2.2rem;
        }

        .calculation-breakdown .foldout-body .foldout-inner {
            border-top: 1px solid var(--border-default);
            padding-top: 0;
            transition: padding-top 0.4s ease;
        }

        .calculation-breakdown .foldout-body.open .foldout-inner {
            padding-top: 1.8rem;
        }

        /* ===== RESULTS HEATMAP CALLOUT ===== */
        .heatmap-callout {
            background: var(--bg-surface);
            border: 2px solid var(--border-default);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .heatmap-callout-header {
            padding: 1.8rem 2.2rem 0;
        }

        .heatmap-callout-header h2 {
            margin: 0 0 0.2rem 0;
            font-size: 1.6rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
            line-height: 1.3;
        }

        .heatmap-callout-desc {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 0;
            line-height: 1.4;
        }

        .heatmap-callout-body {
            padding: 1.6rem 2.2rem 2.2rem;
        }

        /* ===== HEATMAP TABLE ===== */
        .heatmap-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .heatmap-table {
            border-collapse: separate;
            border-spacing: 3px;
            width: 100%;
            min-width: 480px;
            font-family: var(--sans);
            font-size: 0.82rem;
        }

        .heatmap-table th {
            padding: 0.6rem 0.5rem;
            font-weight: 600;
            font-size: 0.78rem;
            color: var(--text-secondary);
            text-align: center;
            white-space: nowrap;
        }

        .heatmap-table th.heatmap-corner {
            background: transparent;
        }

        .heatmap-table th.heatmap-col-header {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            height: 85px;
            vertical-align: bottom;
            padding-bottom: 0.5rem;
            font-size: 0.78rem;
            letter-spacing: 0.02em;
        }

        .heatmap-table th.heatmap-row-header {
            text-align: right;
            padding-right: 0.9rem;
            color: var(--text-primary);
            white-space: nowrap;
            font-size: 0.78rem;
            letter-spacing: 0.02em;
        }

        .heatmap-table td {
            text-align: center;
            padding: 0.6rem 0.45rem;
            font-size: 0.82rem;
            font-weight: 600;
            border-radius: 4px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            cursor: default;
            position: relative;
        }

        .heatmap-table td:hover:not(.heatmap-diagonal) {
            transform: scale(1.06);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1;
        }

        .heatmap-table td.heatmap-diagonal {
            background: var(--bg-surface-hover);
            color: var(--text-tertiary);
            font-size: 0.7rem;
            font-weight: 400;
        }

        .heatmap-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .heatmap-axis-label {
            font-size: 0.72rem;
            color: var(--accent-blue);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-family: var(--sans);
        }

        @media (max-width: 600px) {
            .heatmap-callout-header {
                padding: 1.2rem 1.2rem 0;
            }
            .heatmap-callout-body {
                padding: 1rem 1.2rem 1.4rem;
            }
            .heatmap-table th.heatmap-col-header {
                height: 65px;
                font-size: 0.65rem;
            }
            .heatmap-table th.heatmap-row-header {
                font-size: 0.65rem;
                padding-right: 0.4rem;
            }
            .heatmap-table td {
                font-size: 0.7rem;
                padding: 0.4rem 0.25rem;
            }
        }

        .breakdown-desc {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .breakdown-desc:last-of-type {
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-gold);
            margin-left: 0;
            font-size: 0.85rem;
        }

        .candidate-breakdown {
            margin-bottom: 0.75rem;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            border-radius: 6px;
            overflow: hidden;
        }

        .breakdown-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            font-family: inherit;
            text-align: left;
            gap: 1rem;
        }

        .breakdown-toggle:hover {
            background: var(--bg-surface-hover);
        }

        .breakdown-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .breakdown-preview {
            font-size: 0.95rem;
            color: var(--accent-blue);
            font-weight: 700;
            min-width: 60px;
            text-align: right;
        }

        .breakdown-icon {
            font-size: 1.5rem;
            color: var(--accent-blue);
            transition: transform 0.3s ease;
        }

        .candidate-breakdown.open .breakdown-icon {
            transform: rotate(45deg);
        }

        .breakdown-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 1.5rem;
        }

        .candidate-breakdown.open .breakdown-details {
            max-height: 400px;
            padding: 0 1.5rem 1.5rem;
        }

        .breakdown-line {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .breakdown-line strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .breakdown-result {
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-default);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-blue);
        }

        /* Market Sources */
        .additional-markets {
            margin-bottom: 2rem;
        }

        .additional-markets h2 {
            margin-bottom: 1rem;
            font-size: 2rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
        }

        .expandable-market {
            margin-bottom: 1rem;
            border: 1px solid var(--border-default);
            overflow: hidden;
            background: var(--bg-surface);
        }

        .expand-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: background 0.2s ease;
            gap: 2rem;
        }

        .expand-toggle:hover {
            background: var(--bg-surface-hover);
        }

        .market-name {
            font-weight: 600;
            font-size: 0.95rem;
            min-width: 140px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.25rem 0.6rem;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-red);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--accent-red);
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.8);
            animation: pulse-live 2s ease-in-out infinite;
        }

        @keyframes pulse-live {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px rgba(239, 68, 68, 0.8);
            }
            50% {
                opacity: 0.5;
                box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
            }
        }

        .market-preview {
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex: 1;
            text-align: left;
        }

        .expand-icon {
            font-size: 1.5rem;
            color: var(--accent-blue);
            transition: transform 0.3s ease;
        }

        .expandable-market.open .expand-icon {
            transform: rotate(45deg);
        }

        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 1.5rem;
        }

        .expandable-market.open .expand-content {
            max-height: 500px;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .expand-content .market-candidates {
            margin-bottom: 1rem;
        }

        .expand-content .market-candidate {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .expand-content .market-candidate:last-child {
            border-bottom: none;
        }

        .expand-content .market-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-default);
            margin-top: 0.5rem;
        }

        .market-link {
            color: var(--accent-blue);
            text-decoration: underline;
            font-size: 0.9rem;
        }

        .market-link:hover {
            opacity: 0.8;
        }

        /* Download Section */
        .download-data-section {
            padding: 2.5rem;
            background: var(--bg-surface);
            border: 2px solid var(--border-default);
            text-align: center;
            margin-bottom: 2rem;
        }

        .download-data-section h2 {
            margin-bottom: 0.5rem;
            font-size: 2rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
        }

        .download-description {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .download-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .download-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.15s ease;
            border: none;
            cursor: pointer;
        }

        .download-button:hover {
            opacity: 0.8;
        }

        .download-icon {
            font-size: 1.2rem;
        }

        .download-button-secondary {
            background: transparent;
            border: 2px solid var(--text-primary);
            color: var(--text-primary);
        }

        .download-button-secondary:hover {
            background: var(--bg-surface-hover);
            opacity: 1;
        }

        /* Email Alerts Section */
        .email-alerts-section {
            padding: 2.5rem;
            background: var(--bg-surface);
            border: 2px solid var(--border-default);
            text-align: center;
            margin-bottom: 2rem;
        }

        .email-alerts-section h2 {
            margin-bottom: 0.5rem;
            font-size: 2rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
        }

        .alerts-description {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .subscribe-form {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .subscribe-input {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: var(--sans);
            width: 280px;
            max-width: 100%;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .subscribe-input:focus {
            border-color: var(--accent-blue);
        }

        .subscribe-input::placeholder {
            color: var(--text-tertiary);
        }

        .subscribe-threshold {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: var(--sans);
            width: 200px;
            max-width: 100%;
            outline: none;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        .subscribe-threshold:focus {
            border-color: var(--accent-blue);
        }

        .subscribe-button {
            padding: 0.75rem 1.5rem;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.15s ease;
            font-family: var(--sans);
        }

        .subscribe-button:hover {
            opacity: 0.8;
        }

        .subscribe-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .subscribe-message {
            margin-top: 1rem;
            font-size: 0.9rem;
            min-height: 1.4em;
        }

        .subscribe-message.success {
            color: var(--accent-green);
        }

        .subscribe-message.error {
            color: var(--accent-red);
        }

        /* Email Subscribe Modal Popup */
        .email-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        .email-modal.show {
            display: block;
        }

        .email-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
        }

        .email-modal-content {
            position: relative;
            max-width: 500px;
            margin: 15% auto;
            background: var(--bg-surface);
            border: 2px solid var(--border-hover);
            padding: 40px;
            box-shadow: 0 8px 32px var(--shadow-soft);
            animation: slideUp 0.4s ease-out;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .email-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 32px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            transition: color 0.2s ease;
        }

        .email-modal-close:hover {
            color: var(--accent-blue);
        }

        .email-modal-content h2 {
            margin: 0 0 12px 0;
            font-size: 2rem;
            font-family: var(--serif);
            font-weight: 700;
            color: var(--accent-blue);
        }

        .email-modal-description {
            margin: 0 0 24px 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .last-updated {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .candidate-odds {
            color: var(--accent-blue);
            font-weight: 700;
            font-family: var(--sans);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>
function toggleTheme() {
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('il9-theme', 'light');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('il9-theme', 'dark');
    }
    // Re-render chart with updated theme colors
    if (candidatesData && candidatesData.length > 0) {
        renderMarketTrendChart(candidatesData);
    }
}

// Mobile hamburger menu toggle
function toggleMobileMenu() {
    const hamburger = document.getElementById('hamburger');
    const mobileNav = document.getElementById('mobileNav');
    hamburger.classList.toggle('active');
    mobileNav.classList.toggle('active');
}

// Close mobile menu when a link is clicked
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('#mobileNav a').forEach(link => {
        link.addEventListener('click', () => {
            document.getElementById('hamburger').classList.remove('active');
            document.getElementById('mobileNav').classList.remove('active');
        });
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
        const hamburger = document.getElementById('hamburger');
        const mobileNav = document.getElementById('mobileNav');
        if (!hamburger.contains(e.target) && !mobileNav.contains(e.target)) {
            hamburger.classList.remove('active');
            mobileNav.classList.remove('active');
        }
    });

    // Share button functionality
    const shareButton = document.getElementById('shareButton');
    if (shareButton) {
        shareButton.addEventListener('click', async () => {
            const leaderName = document.getElementById('leaderName')?.textContent || 'Loading...';
            const leaderProb = document.getElementById('leaderAggregate')?.textContent || '--';

            const shareData = {
                title: 'IL9Cast - Illinois 9th District Primary Forecast',
                text: `${leaderName} leads at ${leaderProb} in the IL-9 Democratic Primary prediction markets`,
                url: window.location.href
            };

            // Try native share (mobile)
            if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                try {
                    await navigator.share(shareData);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                        fallbackCopyLink();
                    }
                }
            } else {
                // Fallback: copy link to clipboard (desktop)
                fallbackCopyLink();
            }
        });
    }

    function fallbackCopyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            const shareText = document.querySelector('.share-text');
            const originalText = shareText.textContent;
            shareText.textContent = 'Link Copied!';
            setTimeout(() => {
                shareText.textContent = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Copy failed:', err);
            alert('Share URL: ' + window.location.href);
        });
    }
});

// Central Time formatter utility
function formatCentralTime(date, options = {}) {
    const defaults = {
        timeZone: 'America/Chicago',
        hour12: true
    };
    const formatter = new Intl.DateTimeFormat('en-US', { ...defaults, ...options });
    return formatter.format(date) + ' CT';
}

// Update status badges based on data freshness
function updateStatusBadges(manifoldTime, kalshiTime) {
    const now = Date.now();
    const staleThreshold = 5 * 60 * 1000; // 5 minutes

    // Manifold status - always show as vivid
    const manifoldBadge = document.getElementById('manifoldBadge');
    if (manifoldBadge) {
        manifoldBadge.style.opacity = '1';
    }

    // Kalshi status - always show as vivid
    const kalshiBadge = document.getElementById('kalshiBadge');
    if (kalshiBadge) {
        kalshiBadge.style.opacity = '1';
    }

    // Railway is always live
    const railwayDot = document.getElementById('railwayDot');
    if (railwayDot) {
        railwayDot.classList.add('online');
    }

    // AWS is always live
    const awsDot = document.getElementById('awsDot');
    if (awsDot) {
        awsDot.classList.add('online');
    }
}

let marketChart = null;
let candidatesData = [];
let manifoldData = {};
let kalshiData = {};
let currentChartPeriod = '7d';
let manifoldLastUpdate = null;
let kalshiLastUpdate = null;

// Candidate headshot mapping
const candidateImages = {
    'daniel biss': '/static/images/candidates/biss.jpg',
    'biss': '/static/images/candidates/biss.jpg',
    'erin bushra': '/static/images/candidates/bushra.png',
    'bushra': '/static/images/candidates/bushra.png',
    'robert fine': '/static/images/candidates/fine.png',
    'fine': '/static/images/candidates/fine.png',
    'kat abugazaleh': '/static/images/candidates/katabu.png',
    'abugazaleh': '/static/images/candidates/katabu.png',
    'mike simmons': '/static/images/candidates/simmons.jpg',
    'simmons': '/static/images/candidates/simmons.jpg',
    'phil andrew': '/static/images/candidates/philandrew.png',
    'andrew': '/static/images/candidates/philandrew.png'
};

function getCandidateImage(name) {
    const normalized = name.toLowerCase().trim();
    // Try full name first
    if (candidateImages[normalized]) return candidateImages[normalized];
    // Try last name
    const lastName = normalized.split(' ').pop();
    if (candidateImages[lastName]) return candidateImages[lastName];
    // Default placeholder
    return null;
}

function toggleMarket(id) {
    const market = document.getElementById(id);
    market.classList.toggle('open');
}

function normalizeCandidate(name) {
    // Extract just the candidate name for matching
    let cleaned = name.toLowerCase()
        .replace(/^wil\s+/i, '') // Remove "Wil " prefix from Kalshi
        .replace(/^will\s+/i, '') // Remove "Will " prefix
        .replace(/\sbe\sthe\sdemocratic\snominee.*$/i, '') // Remove suffix
        .replace(/\swin.*$/i, '') // Remove "win..." suffix
        .replace(/dr\.\s+/i, '')
        .trim();

    // Handle name variations/misspellings
    const nameVariations = {
        'kat abughazaleh': 'kat abugazaleh',
        // Add more variations as needed
    };

    if (nameVariations[cleaned]) {
        cleaned = nameVariations[cleaned];
    }

    return cleaned;
}

function cleanCandidateName(name) {
    // Clean up display name for better readability
    return name
        .replace(/^wil\s+/i, '') // Remove "Wil " prefix
        .replace(/^will\s+/i, '') // Remove "Will " prefix
        .replace(/\sbe\sthe\sdemocratic\snominee.*$/i, '') // Remove question suffix
        .replace(/\?/g, '') // Remove question marks
        .trim();
}

async function calculateAggregate() {
    // Match candidates across platforms and calculate aggregated probabilities
    const aggregated = [];
    const breakdowns = [];

    // Get all unique candidates
    const allCandidates = new Set();
    Object.keys(manifoldData).forEach(name => allCandidates.add(name));
    Object.keys(kalshiData).forEach(name => allCandidates.add(name));

    allCandidates.forEach(candidateKey => {
        // Filter out Jan Schakowsky
        if (candidateKey.toLowerCase().includes('schakowsky')) {
            return;
        }

        const manifoldProb = manifoldData[candidateKey]?.probability || 0;
        const kalshiInfo = kalshiData[candidateKey] || {};
        const kalshiLast = kalshiInfo.last_price || 0;
        const kalshiMid = kalshiInfo.midpoint || 0;

        // Check if this candidate has Kalshi market
        const hasKalshi = kalshiLast > 0 || kalshiMid > 0;

        // Calculate liquidity-weighted price
        // Use pre-calculated liquidity-weighted probability from fetchKalshiData
        const kalshiLiquidity = kalshiInfo.kalshiLiquidity || kalshiMid;

        let aggregate;

        // Spread-based weight throttle
        let isThrottled = false;
        if (hasKalshi) {
            const kalshiBid = kalshiInfo.yes_bid || 0;
            const kalshiAsk = kalshiInfo.yes_ask || 0;
            const lastOutsideSpread = (
                kalshiBid > 0 && kalshiAsk > 0 &&
                (kalshiLast > kalshiAsk || kalshiLast < kalshiBid)
            );
            if (lastOutsideSpread) {
                // Throttled: reduce last_price weight, boost spread-based components
                aggregate = (0.40 * manifoldProb) + (0.20 * kalshiLast) + (0.28 * kalshiMid) + (0.12 * kalshiLiquidity);
                isThrottled = true;
            } else {
                // Normal weights
                aggregate = (0.40 * manifoldProb) + (0.42 * kalshiLast) + (0.12 * kalshiMid) + (0.06 * kalshiLiquidity);
            }
        } else {
            aggregate = manifoldProb;
        }

        if (aggregate > 0 || manifoldProb > 0) {
            // Use cleaned display name
            const displayName = manifoldData[candidateKey]?.displayName || kalshiInfo.displayName || candidateKey;
            const cleanName = cleanCandidateName(displayName);

            aggregated.push({
                name: cleanName,
                probability: aggregate,
                hasKalshi: hasKalshi
            });

            // Store breakdown for display with correct weights
            const wManifold = hasKalshi ? 0.40 : 1.0;
            const wLast = isThrottled ? 0.20 : 0.42;
            const wMid = isThrottled ? 0.28 : 0.12;
            const wLiq = isThrottled ? 0.12 : 0.06;

            breakdowns.push({
                name: cleanName,
                manifoldProb: manifoldProb.toFixed(1),
                kalshiLast: kalshiLast.toFixed(1),
                kalshiMid: kalshiMid.toFixed(1),
                kalshiLiq: kalshiLiquidity.toFixed(1),
                manifoldContribution: (wManifold * manifoldProb).toFixed(2),
                kalshiLastContribution: (wLast * kalshiLast).toFixed(2),
                kalshiMidContribution: (wMid * kalshiMid).toFixed(2),
                kalshiLiqContribution: (wLiq * kalshiLiquidity).toFixed(2),
                aggregate: aggregate.toFixed(1),
                hasKalshi: hasKalshi,
                isThrottled: isThrottled,
                wLast: wLast,
                wMid: wMid,
                wLiq: wLiq
            });
        }
    });

    // Soft normalization - only apply 30% of adjustment to keep top candidates higher
    const NORMALIZATION_STRENGTH = 0.30; // 30% normalization, 70% raw values
    const total = aggregated.reduce((sum, c) => sum + c.probability, 0);
    if (total > 0) {
        aggregated.forEach(c => {
            const fullyNormalized = (c.probability / total) * 100;
            const adjustment = fullyNormalized - c.probability;
            c.probability = c.probability + (adjustment * NORMALIZATION_STRENGTH);
        });
        breakdowns.forEach(b => {
            const oldAggregate = parseFloat(b.aggregate);
            const fullyNormalized = (oldAggregate / total) * 100;
            const adjustment = fullyNormalized - oldAggregate;
            b.normalizedAggregate = (oldAggregate + (adjustment * NORMALIZATION_STRENGTH)).toFixed(1);
        });
    }

    aggregated.sort((a, b) => b.probability - a.probability);
    breakdowns.sort((a, b) => parseFloat(b.normalizedAggregate || b.aggregate) - parseFloat(a.normalizedAggregate || a.aggregate));

    // Store aggregated data for chart updates
    candidatesData = aggregated;

    // Save snapshot as backup (backend also saves every 3 min)
    // Frontend saves only when page is viewed, backend ensures continuous collection
    await saveSnapshot(aggregated);

    renderBigOdds(aggregated);

    // Render chart with aggregated data (handles both 30d and 1h views)
    await renderMarketTrendChart(aggregated);

    renderBreakdown(breakdowns);
    renderHeatmap(aggregated);
}

async function saveSnapshot(candidates) {
    try {
        const snapshot = {
            candidates: candidates.map(c => ({
                name: c.name,
                probability: Math.round(c.probability * 10) / 10,
                hasKalshi: c.hasKalshi
            }))
        };

        await fetch('/api/snapshot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(snapshot)
        });
    } catch (error) {
        console.error('Error saving snapshot:', error);
    }
}

function renderBreakdown(breakdowns) {
    const container = document.getElementById('breakdownContent');

    container.innerHTML = breakdowns.map((b, idx) => {
        const asterisk = !b.hasKalshi ? '*' : '';
        const finalProb = b.normalizedAggregate || b.aggregate;

        let calculationHTML;
        if (b.hasKalshi) {
            const throttleNote = b.isThrottled ? `<div class="breakdown-line" style="margin-top: 0.4rem; color: var(--accent-color); font-size: 0.85em;"><em>Last price outside spread â€” weight throttled</em></div>` : '';
            calculationHTML = `
                <div class="breakdown-line"><strong>Manifold:</strong> <span style="color: var(--accent-blue); font-weight: 600;">${b.manifoldProb}%</span></div>
                <div class="breakdown-line"><strong>Kalshi Last Price:</strong> <span style="color: var(--accent-blue); font-weight: 600;">${b.kalshiLast}%</span>${b.isThrottled ? ' <span style="color: var(--accent-color); font-size: 0.85em;">(outside spread)</span>' : ''}</div>
                <div class="breakdown-line"><strong>Kalshi Midpoint:</strong> <span style="color: var(--accent-blue); font-weight: 600;">${b.kalshiMid}%</span></div>
                <div class="breakdown-line"><strong>Kalshi Liquidity-Weighted:</strong> <span style="color: var(--accent-blue); font-weight: 600;">${b.kalshiLiq}%</span></div>
                ${throttleNote}
                <div class="breakdown-line" style="margin-top: 0.8rem;">
                    <strong>Calculation:</strong><br>
                    (0.40 Ã— ${b.manifoldProb}) + (${b.wLast} Ã— ${b.kalshiLast}) + (${b.wMid} Ã— ${b.kalshiMid}) + (${b.wLiq} Ã— ${b.kalshiLiq})<br>
                    = ${b.manifoldContribution} + ${b.kalshiLastContribution} + ${b.kalshiMidContribution} + ${b.kalshiLiqContribution}
                </div>
                <div class="breakdown-result">= ${b.aggregate}%</div>
                ${b.normalizedAggregate ? `<div class="breakdown-line" style="margin-top: 0.5rem; color: var(--text-secondary);"><strong>Soft Normalized (30%):</strong> ${b.normalizedAggregate}%</div>` : ''}
            `;
        } else {
            calculationHTML = `
                <div class="breakdown-line"><strong>Manifold:</strong> <span style="color: var(--accent-blue); font-weight: 600;">${b.manifoldProb}%</span></div>
                <div class="breakdown-line" style="color: var(--text-secondary);"><strong>Kalshi:</strong> No market available</div>
                <div class="breakdown-line" style="margin-top: 0.8rem;">
                    <strong>Calculation:</strong><br>
                    Using 100% of Manifold probability (no Kalshi data)<br>
                    = ${b.manifoldProb}%
                </div>
                ${b.normalizedAggregate ? `<div class="breakdown-line" style="margin-top: 0.5rem; color: var(--text-secondary);"><strong>Soft Normalized (30%):</strong> ${b.normalizedAggregate}%<br><em style="font-size: 0.85em;">Light normalization applied to prevent drift while preserving market values.</em></div>` : ''}
            `;
        }

        return `
        <div class="candidate-breakdown" id="breakdown-${idx}">
            <button class="breakdown-toggle" onclick="toggleBreakdown(${idx})">
                <span class="breakdown-header">${b.name}${asterisk}</span>
                <span class="breakdown-preview">${finalProb}%</span>
                <span class="breakdown-icon">+</span>
            </button>
            <div class="breakdown-details">
                ${calculationHTML}
            </div>
        </div>
        `;
    }).join('');
}

function toggleBreakdown(idx) {
    const breakdown = document.getElementById(`breakdown-${idx}`);
    breakdown.classList.toggle('open');
}

function toggleCalcFoldout() {
    const body = document.getElementById('calc-foldout-body');
    const arrow = document.getElementById('calc-foldout-arrow');
    const foldout = document.getElementById('calculationBreakdown');
    body.classList.toggle('open');
    arrow.classList.toggle('open');
    foldout.classList.toggle('active');
}

function renderHeatmap(candidates) {
    const container = document.getElementById('heatmapContent');
    if (!candidates || candidates.length < 2) {
        container.innerHTML = '<p style="color: var(--text-secondary);">Waiting for market data...</p>';
        return;
    }

    // Sort by probability descending, take top 6
    const sorted = candidates.slice().sort((a, b) => b.probability - a.probability).slice(0, 6);
    const n = sorted.length;

    // Compute conditional probability matrix
    // P(row=1st, col=2nd) = P(row wins) * P(col wins) / (1 - P(row wins))
    const matrix = [];
    let maxVal = 0;
    let topPair = { val: 0, i: 0, j: 0 };
    for (let i = 0; i < n; i++) {
        matrix[i] = [];
        const pWin = sorted[i].probability / 100;
        for (let j = 0; j < n; j++) {
            if (i === j) {
                matrix[i][j] = null;
            } else {
                const pOther = sorted[j].probability / 100;
                const denom = 1 - pWin;
                const val = denom > 0 ? (pWin * pOther / denom) * 100 : 0;
                matrix[i][j] = val;
                if (val > maxVal) { maxVal = val; topPair = { val, i, j }; }
            }
        }
    }

    // Color ramp: low values get subtle tint, high values get strong teal
    function cellStyle(val, isTop) {
        if (val === null) return '';
        const t = maxVal > 0 ? val / maxVal : 0;
        const alpha = 0.05 + t * 0.6;
        const borderGlow = isTop ? 'box-shadow: inset 0 0 0 1.5px rgba(49, 176, 181, 0.8);' : '';
        return `background: rgba(49, 176, 181, ${alpha.toFixed(3)}); ${borderGlow}`;
    }

    function textStyle(val) {
        if (val === null) return '';
        const t = maxVal > 0 ? val / maxVal : 0;
        if (t > 0.6) return 'color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3);';
        if (t > 0.25) return 'color: rgba(255,255,255,0.9);';
        return 'color: var(--text-secondary);';
    }

    function lastName(name) {
        const parts = name.trim().split(' ');
        return parts[parts.length - 1];
    }

    // Build HTML
    let html = '';

    // Most likely result callout
    html += `<div style="display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1.4rem; padding: 0.75rem 1rem; background: var(--bg-elevated); border-left: 3px solid var(--accent-gold);">`;
    html += `<span style="font-size: 0.78rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600;">Most likely result</span>`;
    html += `<span style="font-size: 0.95rem; color: var(--accent-blue); font-weight: 600;">${lastName(sorted[topPair.i].name)} 1st, ${lastName(sorted[topPair.j].name)} 2nd</span>`;
    html += `<span style="font-size: 0.85rem; color: var(--text-secondary);">${topPair.val.toFixed(1)}%</span>`;
    html += `</div>`;

    // Axis labels
    html += '<div class="heatmap-label-row">';
    html += '<span class="heatmap-axis-label">&#8595; Finishes 1st</span>';
    html += '<span class="heatmap-axis-label">Finishes 2nd &#8594;</span>';
    html += '</div>';

    // Table
    html += '<div class="heatmap-wrapper"><table class="heatmap-table"><thead><tr>';
    html += '<th class="heatmap-corner"></th>';
    for (let j = 0; j < n; j++) {
        html += `<th class="heatmap-col-header">${lastName(sorted[j].name)}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (let i = 0; i < n; i++) {
        html += '<tr>';
        html += `<th class="heatmap-row-header">${lastName(sorted[i].name)}</th>`;
        for (let j = 0; j < n; j++) {
            const val = matrix[i][j];
            if (val === null) {
                html += '<td class="heatmap-diagonal">&mdash;</td>';
            } else {
                const isTop = (i === topPair.i && j === topPair.j);
                const display = val < 0.1 ? '<0.1' : val.toFixed(1);
                html += `<td style="${cellStyle(val, isTop)} ${textStyle(val)}" title="${sorted[i].name} 1st, ${sorted[j].name} 2nd: ${val.toFixed(2)}%">${display}%</td>`;
            }
        }
        html += '</tr>';
    }

    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function fetchManifoldData() {
    try {
        const response = await fetch('/api/manifold');
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Extract answers with probabilities
        const answers = data.answers || [];
        const manifoldList = answers
            .map(a => ({
                name: a.text,
                probability: Math.round(a.probability * 1000) / 10
            }))
            .filter(a => a.name !== 'Other' && !a.name.toLowerCase().includes('schakowsky'))
            .sort((a, b) => b.probability - a.probability);

        // Store in lookup object
        manifoldList.forEach(c => {
            const key = normalizeCandidate(c.name);
            manifoldData[key] = {
                displayName: c.name,
                probability: c.probability
            };
        });

        renderManifoldExpanded(manifoldList);

        // Update timestamp
        const updated = new Date(data.lastBetTime || data.lastUpdatedTime);
        manifoldLastUpdate = updated.getTime();
        document.getElementById('manifoldUpdated').textContent = `Updated ${formatCentralTime(updated, {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit'
        })}`;

        // Update status badges
        updateStatusBadges(manifoldLastUpdate, kalshiLastUpdate);

        // Calculate aggregate if both data sources are ready
        if (Object.keys(kalshiData).length > 0 && Object.keys(manifoldData).length > 0) {
            console.log('Recalculating aggregate with updated Manifold data');
            await calculateAggregate();
        } else {
            console.log('Waiting for both data sources. Manifold:', Object.keys(manifoldData).length, 'Kalshi:', Object.keys(kalshiData).length);
        }

    } catch (error) {
        console.error('Error fetching Manifold data:', error);
        document.getElementById('bigOddsDisplay').innerHTML = '<p style="color: var(--text-secondary);">Error loading market data</p>';
    }
}

function renderBigOdds(candidates) {
    // Update leader featured card
    if (candidates.length > 0) {
        const leader = candidates[0];
        const leaderImage = getCandidateImage(leader.name);
        const photoEl = document.getElementById('leaderPhoto');
        const nameEl = document.getElementById('leaderName');
        const aggregateEl = document.getElementById('leaderAggregate');
        const manifoldEl = document.getElementById('leaderManifold');
        const kalshiLastEl = document.getElementById('leaderKalshiLast');
        const kalshiMidEl = document.getElementById('leaderKalshiMid');
        const kalshiLiqEl = document.getElementById('leaderKalshiLiq');

        if (leaderImage) {
            photoEl.src = leaderImage;
            photoEl.alt = leader.name;
            photoEl.style.display = 'block';
        } else {
            photoEl.style.display = 'none';
        }
        nameEl.textContent = leader.name;
        aggregateEl.textContent = Math.round(leader.probability) + '%';

        // Get Manifold and Kalshi data for leader
        const leaderKey = normalizeCandidate(leader.name);
        const manifoldProb = manifoldData[leaderKey]?.probability || 0;
        const kalshiInfo = kalshiData[leaderKey] || {};
        const kalshiLast = kalshiInfo.last_price || 0;
        const kalshiMid = kalshiInfo.midpoint || 0;
        const kalshiLiq = kalshiInfo.kalshiLiquidity || 0;

        manifoldEl.textContent = manifoldProb > 0 ? manifoldProb.toFixed(1) + '%' : '--';
        kalshiLastEl.textContent = kalshiLast > 0 ? kalshiLast.toFixed(1) + '%' : '--';
        kalshiMidEl.textContent = kalshiMid > 0 ? kalshiMid.toFixed(1) + '%' : '--';
        kalshiLiqEl.textContent = kalshiLiq > 0 ? kalshiLiq.toFixed(1) + '%' : '--';
    }

    // Update other candidates grid (skip leader)
    const container = document.getElementById('bigOddsDisplay');
    container.innerHTML = candidates.slice(1, 6).map((c) => {
        const asterisk = !c.hasKalshi ? '*' : '';
        return `
        <div class="big-odds-candidate">
            <span class="big-percent">${Math.round(c.probability)}%</span>
            <span class="big-name">${c.name}${asterisk}</span>
        </div>
        `;
    }).join('');
}

function renderManifoldExpanded(candidates) {
    // Update preview
    const top = candidates[0];
    document.getElementById('manifoldPreview').textContent = `Top: ${top.name.split(' ')[1]} ${Math.round(top.probability)}%`;

    // Update expanded list
    const container = document.getElementById('manifoldCandidates');
    container.innerHTML = candidates.map(c => `
        <div class="market-candidate">
            <span class="candidate-name">${c.name}</span>
            <span class="candidate-odds">${c.probability}%</span>
        </div>
    `).join('');
}


// Known gap ranges (populated from API response)
let knownGaps = [];

function isInGap(t0, t1) {
    // Check if the segment between t0 and t1 crosses a known data gap
    for (const gap of knownGaps) {
        // Segment crosses gap if it starts before gap ends and ends after gap starts
        if (t0 < gap.end && t1 > gap.start) {
            return true;
        }
    }
    return false;
}

async function renderMarketTrendChart(candidates) {
    const ctx = document.getElementById('marketTrendChart').getContext('2d');
    const period = currentChartPeriod || '7d';

    // Fetch RDP-simplified data from backend
    let chartData = {};
    try {
        const response = await fetch(`/api/snapshots/chart?period=${period}&epsilon=0.5`);
        chartData = await response.json();
    } catch (error) {
        console.error('Error fetching chart data:', error);
    }

    const snapshots = chartData.snapshots || [];
    // Parse gap ranges from backend (detected on raw data, not RDP-simplified)
    knownGaps = (chartData.gaps || []).map(g => ({
        start: new Date(g.start).getTime(),
        end: new Date(g.end).getTime()
    }));

    console.log(`[Chart] Known gaps: ${knownGaps.length}`, knownGaps);

    // Theme-aware chart colors
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const chartTextColor = isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.7)';
    const chartGridColor = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
    const chartLegendColor = isDark ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.7)';
    const tooltipBg = isDark ? 'rgba(0,0,0,0.9)' : 'rgba(30,30,30,0.9)';

    if (snapshots.length < 2) {
        if (marketChart) marketChart.destroy();
        ctx.font = '14px Arial';
        ctx.fillStyle = chartTextColor;
        ctx.textAlign = 'center';
        ctx.fillText('Collecting historical data... Check back soon for trend charts.', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    // Parse all timestamps to Date objects
    const parsedSnapshots = snapshots.map(s => {
        const ts = s.timestamp;
        const date = new Date(ts.endsWith('Z') ? ts : ts + 'Z');
        return { date, snapshot: s };
    }).filter(p => !isNaN(p.date.getTime()));

    console.log(`[Chart] Period: ${period}, Data points: ${parsedSnapshots.length}`);

    // Editorial color palette
    const colors = [
        '#31B0B5',  // Teal
        '#40B040',  // Green
        '#F25446',  // Red
        '#F2C306',  // Gold
        '#8B5CF6',  // Purple
        '#9BA1A6'   // Gray
    ];

    // Build datasets with {x, y} point format for time scale
    const topCandidates = candidates.slice(0, 6);
    const datasets = topCandidates.map((c, idx) => {
        const data = [];
        parsedSnapshots.forEach(({ date, snapshot }) => {
            const candidateData = snapshot.candidates.find(sc => sc.name === c.name);
            if (candidateData) {
                data.push({ x: date.getTime(), y: candidateData.probability });
            }
        });

        const baseColor = colors[idx % colors.length];
        const r = parseInt(baseColor.slice(1, 3), 16);
        const g = parseInt(baseColor.slice(3, 5), 16);
        const b = parseInt(baseColor.slice(5, 7), 16);
        const fadedColor = `rgba(${r}, ${g}, ${b}, 0.4)`;

        return {
            label: c.name.split(' ').pop() || c.name,
            data: data,
            borderColor: baseColor,
            backgroundColor: 'transparent',
            borderWidth: 2.5,
            cubicInterpolationMode: 'monotone',
            tension: 0.65,
            fill: false,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointBackgroundColor: baseColor,
            pointBorderColor: '#fff',
            pointBorderWidth: 1.5,
            spanGaps: true,
            segment: {
                borderColor: ctx2 => {
                    const p0 = ctx2.p0;
                    const p1 = ctx2.p1;
                    if (p0 && p1 && p0.parsed && p1.parsed) {
                        if (isInGap(p0.parsed.x, p1.parsed.x)) {
                            return fadedColor;
                        }
                    }
                    return baseColor;
                },
                borderDash: ctx2 => {
                    const p0 = ctx2.p0;
                    const p1 = ctx2.p1;
                    if (p0 && p1 && p0.parsed && p1.parsed) {
                        if (isInGap(p0.parsed.x, p1.parsed.x)) {
                            return [6, 4];
                        }
                    }
                    return [];
                }
            }
        };
    });

    if (marketChart) marketChart.destroy();

    // Determine time unit based on period
    let timeUnit, tooltipFormat;
    if (period === '1d') {
        timeUnit = 'hour';
        tooltipFormat = 'MMM d, h:mm a';
    } else if (period === '7d') {
        timeUnit = 'day';
        tooltipFormat = 'MMM d, h:mm a';
    } else {
        timeUnit = 'day';
        tooltipFormat = 'MMM d, yyyy';
    }

    // X-axis bounds: first data point to now
    const firstTime = parsedSnapshots[0].date.getTime();
    const nowTime = Date.now();

    // Methodology update vertical line plugin
    const methodologyLinePlugin = {
        id: 'methodologyLine',
        afterDraw(chart) {
            const updateTimestamp = new Date('2026-02-06T03:30:00Z').getTime();
            const xScale = chart.scales.x;
            if (!xScale) return;
            const xMin = xScale.min;
            const xMax = xScale.max;
            if (updateTimestamp < xMin || updateTimestamp > xMax) return;

            const xPixel = xScale.getPixelForValue(updateTimestamp);
            const chartArea = chart.chartArea;
            const ctx2 = chart.ctx;
            const isDarkNow = document.documentElement.getAttribute('data-theme') === 'dark';

            ctx2.save();
            ctx2.beginPath();
            ctx2.setLineDash([6, 4]);
            ctx2.strokeStyle = isDarkNow ? 'rgba(255,255,255,0.35)' : 'rgba(0,0,0,0.3)';
            ctx2.lineWidth = 1.5;
            ctx2.moveTo(xPixel, chartArea.top);
            ctx2.lineTo(xPixel, chartArea.bottom);
            ctx2.stroke();

            ctx2.setLineDash([]);
            ctx2.font = "10px 'Source Sans 3', sans-serif";
            ctx2.fillStyle = isDarkNow ? 'rgba(255,255,255,0.5)' : 'rgba(0,0,0,0.45)';
            ctx2.textAlign = 'center';
            ctx2.fillText('Methodology update', xPixel, chartArea.top - 6);
            ctx2.restore();
        }
    };

    marketChart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        plugins: [methodologyLinePlugin],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: false,
                        boxWidth: 12,
                        boxHeight: 12,
                        padding: 15,
                        color: chartLegendColor,
                        font: {
                            family: "'Source Sans 3', sans-serif",
                            size: 12,
                            weight: 'normal'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: tooltipBg,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    padding: 10,
                    cornerRadius: 0,
                    titleFont: {
                        family: "'Source Sans 3', sans-serif",
                        size: 12,
                        weight: 'bold'
                    },
                    bodyFont: {
                        family: "'Source Sans 3', sans-serif",
                        size: 11
                    },
                    callbacks: {
                        title: function(items) {
                            if (items.length > 0) {
                                const date = new Date(items[0].parsed.x);
                                return formatCentralTime(date, {
                                    month: 'short', day: 'numeric', year: 'numeric',
                                    hour: 'numeric', minute: '2-digit'
                                });
                            }
                            return '';
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y?.toFixed(1) || '--'}%`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 10,
                        callback: (value) => value + '%',
                        color: chartTextColor,
                        font: {
                            family: "'Source Sans 3', sans-serif",
                            size: 11
                        },
                        padding: 8
                    },
                    grid: {
                        color: chartGridColor,
                        drawBorder: false,
                        lineWidth: 1
                    },
                    border: {
                        display: false
                    }
                },
                x: {
                    type: 'time',
                    min: firstTime,
                    max: nowTime,
                    time: {
                        unit: timeUnit,
                        tooltipFormat: tooltipFormat,
                        displayFormats: {
                            hour: 'h a',
                            day: 'MMM d'
                        }
                    },
                    ticks: {
                        color: chartTextColor,
                        autoSkip: true,
                        maxTicksLimit: period === '1d' ? 12 : (period === '7d' ? 7 : 10),
                        font: {
                            family: "'Source Sans 3', sans-serif",
                            size: 10
                        },
                        maxRotation: 0,
                        callback: function(value, index, ticks) {
                            const utcDate = new Date(value);
                            const formatter = new Intl.DateTimeFormat('en-US', {
                                timeZone: 'America/Chicago',
                                hour: timeUnit === 'hour' ? 'numeric' : undefined,
                                day: timeUnit === 'day' ? 'numeric' : undefined,
                                month: timeUnit === 'day' ? 'short' : undefined,
                                hour12: true
                            });
                            return formatter.format(utcDate);
                        }
                    },
                    grid: {
                        color: chartGridColor,
                        drawBorder: false
                    },
                    border: {
                        display: false
                    }
                }
            }
        }
    });
}

async function fetchKalshiData() {
    try {
        console.log('Fetching Kalshi data...');
        const response = await fetch('/api/kalshi');
        const data = await response.json();

        if (data.error) {
            throw new Error(data.error);
        }

        // Extract markets - each market is a candidate
        const markets = data.markets || [];

        console.log('Kalshi response received. Markets count:', markets.length);
        console.log('Kalshi markets:', markets); // Debug log
        console.log('Kalshi data full response:', data);

        const kalshiList = [];

        markets.forEach(m => {
            // Extract candidate name from subtitle or title
            let displayName = m.subtitle || m.title;

            // Filter out Jan Schakowsky
            if (displayName.toLowerCase().includes('schakowsky')) {
                return;
            }

            const last_price = m.last_price || 0;
            const yes_bid = m.yes_bid || 0;
            const yes_ask = m.yes_ask || 0;

            // Only compute a real midpoint when both sides have orders.
            // If yes_bid is 0 (no buy-side interest), midpoint between 0
            // and the ask is meaningless â€” fall back to last_price.
            const midpoint = (yes_bid > 0 && yes_ask > 0) ? (yes_bid + yes_ask) / 2 : last_price;

            // Extract order book volume data
            const yes_bid_volume = m.yes_bid_size || 0;
            const no_bid_volume = m.no_bid_size || 0;

            if (last_price > 0 || midpoint > 0) {
                const key = normalizeCandidate(displayName);
                const localMid = midpoint;

                // Liquidity-weighted price based on last trade position within spread
                // Only use spread when both bid and ask exist
                const spread = (yes_bid > 0 && yes_ask > 0) ? (yes_ask - yes_bid) : 0;
                let kalshiLiquidity = localMid;

                console.log(`${displayName} RAW DATA: yes_bid=${yes_bid}, yes_ask=${yes_ask}, last=${last_price}, spread=${spread.toFixed(2)}, mid=${localMid.toFixed(1)}`);

                if (spread > 0 && last_price > 0) {
                    // Liquidity weighting: where did the last trade occur within the spread?
                    // - Last price near ask (1.0) â†’ buyers aggressive â†’ shift up
                    // - Last price near bid (0.0) â†’ sellers aggressive â†’ shift down
                    // - Last price at mid (0.5) â†’ balanced â†’ no shift

                    // Position in spread: 0 = at bid, 0.5 = at mid, 1 = at ask
                    const positionInSpread = Math.max(0, Math.min(1, (last_price - yes_bid) / spread));

                    // Offset from midpoint: -0.5 to +0.5
                    const offsetFromMid = positionInSpread - 0.5;

                    // Spread dampening: wider spreads = less confidence in the signal
                    // At 0pp spread: factor = 1.0 (full shift potential)
                    // At 10pp spread: factor = 0.2 (heavily dampened)
                    const spreadFactor = Math.max(0.2, 1 - (spread / 10) * 0.8);

                    // Multiply by spread (not a fixed constant) so the shift is
                    // proportional to the spread width and can never leave [bid, ask].
                    const priceShift = offsetFromMid * spread * spreadFactor;

                    kalshiLiquidity = Math.max(yes_bid, Math.min(yes_ask, localMid + priceShift));

                    console.log(`${displayName} liquidity: pos_in_spread=${positionInSpread.toFixed(2)}, offset=${offsetFromMid.toFixed(2)}, spread_factor=${spreadFactor.toFixed(2)}, shift=${priceShift.toFixed(2)}, result=${kalshiLiquidity.toFixed(1)}`);
                } else {
                    console.log(`${displayName} NO spread/last data - using midpoint ${localMid}`);
                }

                kalshiData[key] = {
                    displayName: displayName,
                    last_price: last_price,
                    yes_bid: yes_bid,
                    yes_ask: yes_ask,
                    midpoint: midpoint,
                    yes_bid_volume: yes_bid_volume,
                    no_bid_volume: no_bid_volume,
                    kalshiLiquidity: kalshiLiquidity
                };

                kalshiList.push({
                    name: cleanCandidateName(displayName),
                    probability: Math.round(last_price * 10) / 10
                });
            }
        });

        kalshiList.sort((a, b) => b.probability - a.probability);
        renderKalshiExpanded(kalshiList);

        console.log('Kalshi candidates processed:', kalshiList);
        console.log('Kalshi data object:', kalshiData);

        // Update timestamp
        const kalshiNow = new Date();
        kalshiLastUpdate = kalshiNow.getTime();
        document.getElementById('kalshiUpdated').textContent = `Live data - ${formatCentralTime(kalshiNow, {
            hour: 'numeric', minute: '2-digit', second: '2-digit'
        })}`;

        // Update status badges
        updateStatusBadges(manifoldLastUpdate, kalshiLastUpdate);

        // Calculate aggregate if both Manifold and Kalshi data are ready
        if (Object.keys(manifoldData).length > 0 && Object.keys(kalshiData).length > 0) {
            console.log('Recalculating aggregate with updated Kalshi data');
            console.log('Manifold keys:', Object.keys(manifoldData));
            console.log('Kalshi keys:', Object.keys(kalshiData));
            await calculateAggregate();
        } else {
            console.log('Waiting for both data sources. Manifold:', Object.keys(manifoldData).length, 'Kalshi:', Object.keys(kalshiData).length);
        }

    } catch (error) {
        console.error('Error fetching Kalshi data:', error);
        document.getElementById('kalshiPreview').textContent = 'Error loading';
        document.getElementById('kalshiCandidates').innerHTML = '<p style="color: var(--text-secondary);">Error loading Kalshi data</p>';
    }
}

function renderKalshiExpanded(candidates) {
    if (candidates.length === 0) {
        document.getElementById('kalshiPreview').textContent = 'No data';
        return;
    }

    // Update preview - use last name only
    const top = candidates[0];
    const nameParts = top.name.split(' ');
    const topName = nameParts[nameParts.length - 1]; // Get last name
    document.getElementById('kalshiPreview').textContent = `Top: ${topName} ${Math.round(top.probability)}%`;

    // Update expanded list
    const container = document.getElementById('kalshiCandidates');
    container.innerHTML = candidates.map(c => `
        <div class="market-candidate">
            <span class="candidate-name">${c.name}</span>
            <span class="candidate-odds">${c.probability}%</span>
        </div>
    `).join('');
}

function getPollingInterval() {
    const electionDay = new Date('2026-03-17');
    const today = new Date();
    const millisecondsUntilElection = electionDay - today;
    const daysUntilElection = millisecondsUntilElection / (1000 * 60 * 60 * 24);

    // Election day: poll every 1 minute
    if (daysUntilElection <= 0 && daysUntilElection > -1) {
        return 1 * 60 * 1000; // 1 minute
    }
    // Last 3 days before election: poll every 1 minute
    else if (daysUntilElection <= 3) {
        return 1 * 60 * 1000; // 1 minute
    }
    // Default: poll every 3 minutes
    else {
        return 3 * 60 * 1000; // 3 minutes
    }
}

function setupPolling() {
    // Initial fetch
    fetchManifoldData();
    fetchKalshiData();

    // Set up interval polling with dynamic intervals
    let currentInterval = null;

    function setupNextPoll() {
        const interval = getPollingInterval();

        if (currentInterval) {
            clearInterval(currentInterval);
        }

        currentInterval = setInterval(() => {
            fetchManifoldData();
            fetchKalshiData();
            setupNextPoll(); // Re-check interval after each poll in case it changed
        }, interval);

        console.log(`Polling set to every ${interval / 1000 / 60} minute(s)`);
    }

    setupNextPoll();
}

document.addEventListener('DOMContentLoaded', () => {
    // Set up chart toggle buttons
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');

            currentChartPeriod = e.target.dataset.period;

            // Render chart with the selected period (handles both 30d and 1h)
            await renderMarketTrendChart(candidatesData);
        });
    });

    setupPolling();
});
    </script>

    <script>
    function handleSubscribe(e) {
        e.preventDefault();
        var email = document.getElementById('subscribeEmail').value;
        var threshold = parseFloat(document.getElementById('subscribeThreshold').value);
        var btn = document.querySelector('.subscribe-button');
        var msg = document.getElementById('subscribeMessage');
        btn.disabled = true;
        btn.textContent = 'Subscribing...';
        msg.textContent = '';
        msg.className = 'subscribe-message';

        fetch('/api/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, threshold: threshold})
        })
        .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
        .then(function(result) {
            if (result.ok) {
                msg.textContent = result.data.message || 'Subscribed!';
                msg.className = 'subscribe-message success';
                document.getElementById('subscribeEmail').value = '';
            } else {
                msg.textContent = result.data.error || 'Something went wrong.';
                msg.className = 'subscribe-message error';
            }
        })
        .catch(function() {
            msg.textContent = 'Network error. Please try again.';
            msg.className = 'subscribe-message error';
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Subscribe';
        });

        return false;
    }

    // Email Modal Logic
    function closeEmailModal() {
        var modal = document.getElementById('emailModal');
        modal.classList.remove('show');
        localStorage.setItem('emailModalDismissed', 'true');
    }

    function handleSubscribeModal(e) {
        e.preventDefault();
        var email = document.getElementById('subscribeEmailModal').value;
        var threshold = parseFloat(document.getElementById('subscribeThresholdModal').value);
        var btn = e.target.querySelector('.subscribe-button');
        var msg = document.getElementById('subscribeMessageModal');
        btn.disabled = true;
        btn.textContent = 'Subscribing...';
        msg.textContent = '';
        msg.className = 'subscribe-message';

        fetch('/api/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email: email, threshold: threshold})
        })
        .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
        .then(function(result) {
            if (result.ok) {
                msg.textContent = result.data.message || 'Subscribed!';
                msg.className = 'subscribe-message success';
                document.getElementById('subscribeEmailModal').value = '';
                setTimeout(function() {
                    closeEmailModal();
                }, 2000);
            } else {
                msg.textContent = result.data.error || 'Something went wrong.';
                msg.className = 'subscribe-message error';
            }
        })
        .catch(function() {
            msg.textContent = 'Network error. Please try again.';
            msg.className = 'subscribe-message error';
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Subscribe';
        });

        return false;
    }

    // Email modal auto-popup disabled for better UX
    // Users can still manually trigger via inline subscribe form

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEmailModal();
        }
    });
    </script>
</body>
</html>
